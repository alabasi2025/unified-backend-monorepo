# البنية المعمارية لمستودع الخلفية (unified-backend-monorepo)

## نظرة عامة

هذا المستودع هو **العقل المدبر** لمنصة SEMOP. يحتوي على كل المنطق التجاري، الخدمات، والتكاملات مع الأنظمة الخارجية والأجهزة.

## الفلسفة المعمارية

### المبادئ الأساسية

1. **كل شيء هو مكتبة (Everything is a Lib):** كل منطق عمل يتم إنشاؤه كمكتبة معزولة داخل Nx Monorepo.
2. **الطبقات الأربع:** البنية مقسمة إلى 4 طبقات وظيفية واضحة ومحددة.
3. **العزل والاستقلالية:** كل مكتبة مستقلة ولا تعتمد إلا على المكتبات في نفس الطبقة أو الطبقات الأدنى.
4. **قابلية التوسع اللانهائية:** يمكن تحويل أي مكتبة إلى Microservice منفصل في المستقبل.

## البنية الطبقية (Layered Architecture)

```
libs/
├── 1-core-services/           # الطبقة 1: خدمات النواة الأساسية
├── 2-operational-platform/    # الطبقة 2: منصة التحكم والمراقبة التشغيلية (OCMP)
├── 3-vertical-applications/   # الطبقة 3: الأنظمة الرأسية الوظيفية
└── 4-sector-libraries/        # الطبقة 4: المكتبات القطاعية ("الجينات")
```

---

## الطبقة 1: خدمات النواة الأساسية (Core Services)

هذه هي الخدمات الأساسية التي لا يمكن للنظام العمل بدونها. تعمل كأساس صلب لكل شيء آخر.

### المكتبات:

#### 1. `multi-entity`
**الوصف:** إدارة الكيانات المتعددة (Holding → Unit → Project).  
**المسؤولية:** حل معضلة العميل الذي يمتلك شركة قابضة مع وحدات ومشاريع متعددة.  
**الميزات الرئيسية:**
- إنشاء وإدارة الهيكل الهرمي للكيانات
- عزل البيانات على مستوى قاعدة البيانات (Row-Level Security)
- إدارة العلاقات المالية والمخزنية بين الكيانات

#### 2. `identity-and-access`
**الوصف:** إدارة المستخدمين، المصادقة، والصلاحيات.  
**المسؤولية:** التحكم في من يمكنه الوصول إلى ماذا.  
**الميزات الرئيسية:**
- تسجيل الدخول/الخروج (JWT-based Authentication)
- إدارة الأدوار الهرمية (RBAC - Role-Based Access Control)
- صلاحيات دقيقة على مستوى الكيان والمشروع

#### 3. `configuration`
**الوصف:** إدارة مخططات العملاء (Customer Blueprints).  
**المسؤولية:** تحديد الميزات المفعلة لكل عميل دون تغيير الكود.  
**الميزات الرئيسية:**
- تخزين واسترجاع التكوينات الخاصة بكل عميل
- دعم التكوينات الديناميكية (يمكن تغييرها دون إعادة نشر)
- إدارة المكتبات القطاعية المفعلة لكل عميل

#### 4. `billing-engine`
**الوصف:** محرك الفوترة العام.  
**المسؤولية:** إنشاء الفواتير وحساب المستحقات.  
**الميزات الرئيسية:**
- دعم أنواع متعددة من الفواتير (عدادات، خدمات، منتجات)
- حساب الضرائب والخصومات
- التكامل مع نظام المحفظة

#### 5. `wallet-service`
**الوصف:** خدمة المحفظة الإلكترونية.  
**المسؤولية:** إدارة أرصدة العملاء والمعاملات المالية.  
**الميزات الرئيسية:**
- إيداع وسحب الأموال
- ربط مع بوابات الدفع الإلكتروني
- سجل كامل للمعاملات

#### 6. `developer-system`
**الوصف:** "أنا" - الوحدة المركزية للذكاء الاصطناعي.  
**المسؤولية:** التفاعل مع العملاء، فهم المشاكل، واقتراح الحلول.  
**الميزات الرئيسية:**
- واجهة دردشة ذكية مع العملاء
- تحليل الطلبات وتحويلها إلى مهام تطوير
- البحث في قاعدة المعرفة (هل الميزة موجودة مسبقاً؟)
- إنشاء بطاقات تطوير (Development Cards) تلقائياً

---

## الطبقة 2: منصة التحكم والمراقبة التشغيلية (OCMP)

هذه الطبقة هي **الجسر بين العالم الرقمي والعالم المادي**. تتعامل مع الأجهزة، الشبكات، وأجهزة IoT.

### المكتبات:

#### 1. `iot-gateway`
**الوصف:** بوابة استقبال بيانات أجهزة IoT.  
**المسؤولية:** استقبال البيانات من الأجهزة عبر MQTT أو HTTP.  
**الميزات الرئيسية:**
- دعم بروتوكولات متعددة (MQTT, HTTP, WebSocket)
- معالجة البيانات الواردة وتخزينها
- إرسال الأوامر إلى الأجهزة

#### 2. `hardware-adapters`
**الوصف:** محولات للتحدث مع الأجهزة الصناعية.  
**المسؤولية:** ترجمة البروتوكولات الصناعية إلى لغة يفهمها النظام.  
**المحولات المدعومة:**
- **Modbus:** للتحدث مع المولدات ومحولات الطاقة الشمسية
- **SNMP:** لقراءة بيانات الطابعات والأجهزة الشبكية
- **ONVIF:** للتحدث مع الكاميرات وأجهزة NVR

#### 3. `network-adapters`
**الوصف:** محولات للتحدث مع أجهزة الشبكات.  
**المسؤولية:** مراقبة والتحكم في الشبكة المحلية.  
**المحولات المدعومة:**
- **UniFi:** للتحكم في أجهزة Ubiquiti UniFi (المستوى 3)
- **MikroTik:** للتحكم في أجهزة MikroTik (المستوى 2)
- **ICMP Ping:** للمراقبة الأساسية (المستوى 0)

---

## الطبقة 3: الأنظمة الرأسية الوظيفية (Vertical Applications)

هذه هي الأنظمة الأساسية التي يحتاجها أي عميل، بغض النظر عن قطاعه.

### المكتبات:

#### 1. `accounting`
**الوصف:** النظام المحاسبي الكامل.  
**الميزات الرئيسية:**
- دفتر الأستاذ العام (General Ledger)
- القيود المزدوجة (Double-Entry Bookkeeping)
- المعاملات البينية بين الوحدات والمشاريع
- التقارير المالية (الميزانية، قائمة الدخل، التدفقات النقدية)

#### 2. `inventory`
**الوصف:** نظام إدارة المخزون.  
**الميزات الرئيسية:**
- تعريف الأصناف والمستودعات
- عمليات الصرف والاستلام
- التحويل بين المستودعات
- الجرد الدوري

#### 3. `scm` (Smart Consumables Management)
**الوصف:** نظام إدارة المواد المستهلكة الذكية.  
**المسؤولية:** تطبيق نموذج CDAM - ربط الأصول بالمواد التي تستهلكها.  
**الميزات الرئيسية:**
- مقارنة الاستهلاك الفعلي (من الأجهزة) بالرصيد المصروف (من المخزون)
- اكتشاف الهدر والتسريب تلقائياً
- إنشاء تنبيهات ومهام صيانة وقائية

#### 4. `assets`
**الوصف:** نظام إدارة الأصول.  
**الميزات الرئيسية:**
- تسجيل الأصول الثابتة
- حساب الإهلاك
- ربط الأصول بالمواد المستهلكة (CDAM Model)
- تتبع الموقع الجغرافي للأصول

#### 5. `crm`
**الوصف:** نظام إدارة علاقات العملاء.  
**الميزات الرئيسية:**
- قاعدة بيانات العملاء
- سجل التفاعلات
- ربط العملاء بالأصول (مثل العدادات في قطاع الطاقة)

#### 6. `tasks-and-workflows`
**الوصف:** نظام إدارة المهام والعمليات.  
**الميزات الرئيسية:**
- إنشاء وتعيين المهام
- سير العمل الآلي (Workflows)
- التنبيهات والإشعارات
- التكامل مع جميع الأنظمة الأخرى

---

## الطبقة 4: المكتبات القطاعية ("الجينات")

هذه هي المكتبات التي تحتوي على منطق الأعمال الخاص بقطاعات معينة. هي "الجينات" التي تجعل النظام يتكيف مع احتياجات كل قطاع.

### المكتبات:

#### 1. `energy-sector`
**الوصف:** منطق الأعمال الخاص بقطاع الطاقة.  
**الميزات:**
- التحكم في المولدات الكهربائية
- التكامل مع محولات الطاقة الشمسية
- إدارة العدادات الذكية (أوفلاين، دفع مسبق، IoT)
- قواعد الفوترة الخاصة بالطاقة

#### 2. `retail-sector`
**الوصف:** منطق الأعمال الخاص بقطاع التجزئة.  
**الميزات:**
- منطق نقاط البيع (POS Transaction Logic)
- إدارة برامج الولاء
- قواعد إعادة تعبئة الأرفف تلقائياً
- طباعة بطاقات الأسعار

---

## قواعد الاعتماد بين الطبقات (Dependency Rules)

```
الطبقة 4 (Sector Libraries)
    ↓ يمكنها الاعتماد على ↓
الطبقة 3 (Vertical Applications)
    ↓ يمكنها الاعتماد على ↓
الطبقة 2 (Operational Platform)
    ↓ يمكنها الاعتماد على ↓
الطبقة 1 (Core Services)
```

**القاعدة الذهبية:** لا يمكن لطبقة أدنى أن تعتمد على طبقة أعلى. هذا يضمن العزل والاستقلالية.

---

## نقطة الدخول: API Gateway

التطبيق الوحيد في `apps/api-gateway` هو نقطة الدخول الوحيدة للنظام. لا يحتوي على أي منطق عمل، بل يقوم فقط بـ:
1. تجميع كل المكتبات المطلوبة
2. توفير واجهة GraphQL موحدة
3. إدارة المصادقة والصلاحيات

---

## التقنيات المستخدمة

- **Nx:** إدارة Monorepo
- **NestJS:** إطار عمل الخلفية
- **Prisma:** ORM لقاعدة البيانات
- **GraphQL:** واجهة API موحدة
- **Jest:** اختبارات الوحدة والتكامل
- **TypeScript:** لغة البرمجة

---

**تم الإنشاء:** 2025-01-20  
**المرحلة:** المرحلة 1 - إعداد المستودعات الثلاثة والبنية التحتية الأساسية  
**الحالة:** ✅ البنية الأساسية جاهزة
