# تحسين خوارزمية اقتراح الحسابات (Account Suggestion Algorithm V2)

**الموقع:** `libs/3-vertical-applications/accounting/smart-journal-entries/smart-learning.service.ts`

**الوظيفة المتأثرة:** `getSuggestedAccounts(dto: AccountSuggestionRequestDto)`

## ملخص التغيير

تم تحسين خوارزمية اقتراح الحسابات الذكية (Smart Account Suggestion) لدمج عامل **التضاؤل الزمني (Time-Decay)**، مما يضمن أن الاقتراحات تعطي وزناً أكبر للحسابات التي تم استخدامها مؤخراً، بالإضافة إلى عدد مرات الاستخدام الإجمالي. هذا يرفع من جودة الاقتراحات ويجعلها أكثر صلة بالسياق الزمني الحالي للمستخدم.

## تفاصيل الخوارزمية الجديدة

1.  **جلب بيانات أكثر:** يتم الآن جلب عدد أكبر من سجلات التعلم (5 أضعاف الحد المطلوب `limit * 5`) لضمان وجود مجموعة كافية من المرشحين قبل تطبيق التصفية والترتيب.
2.  **حساب النقاط الموزونة (Weighted Score):** يتم حساب نقطة موزونة لكل سجل باستخدام المعادلة التالية:
    $$
    \text{Weighted Score} = \text{UsageCount} \times (1 + \text{RecencyFactor})
    $$
3.  **عامل الحداثة (Recency Factor):** يتم حساب عامل الحداثة باستخدام دالة التضاؤل الأسي (Exponential Decay) بنصف عمر (Half-Life) قدره **90 يوماً**.
    $$
    \text{RecencyFactor} = 0.5^{\left(\frac{\text{DaysSinceLastUse}}{90}\right)}
    $$
    *   **التأثير:** الحسابات التي تم استخدامها مؤخراً تحصل على عامل حداثة أعلى (يقترب من 1)، مما يعزز نقاطها الموزونة. الحسابات القديمة جداً يكون عامل الحداثة لها قريباً من الصفر، مما يجعل ترتيبها يعتمد بشكل أساسي على عدد مرات الاستخدام الإجمالي.
4.  **الترتيب والتصفية:** يتم ترتيب السجلات بناءً على **النقاط الموزونة** تنازلياً، ثم يتم أخذ السجلات العشرة الأوائل (`limit`).
5.  **تحسين الأداء:** تم تجميع استعلام جلب تفاصيل الحسابات (Account Details) في استعلام واحد باستخدام `IN` بدلاً من استعلام لكل سجل، مما يقلل من عدد استعلامات قاعدة البيانات ويحسن الأداء بشكل كبير.
6.  **حساب الثقة (Confidence):** يتم حساب الثقة بناءً على عدد مرات الاستخدام الأصلي (`usageCount`) مقارنة بأقصى عدد مرات استخدام في السجلات العشرة الأوائل.

## التغييرات البرمجية الرئيسية

*   **إضافة:** متغيرات `now`، `halfLifeDays`، `scoredLogs`.
*   **إضافة:** منطق حساب `daysSinceLastUse` و `recencyFactor` و `weightedScore`.
*   **تعديل:** تغيير `take: limit` إلى `take: limit * 5` في استعلام `findMany`.
*   **تعديل:** استبدال حلقة `for` التي تجلب الحسابات بشكل فردي بمنطق جلب جماعي باستخدام `this.prisma.$queryRawUnsafe` و `IN` clause.
*   **إضافة:** فرز السجلات بناءً على `weightedScore` قبل تطبيق `slice(0, limit)`.

**ملاحظة:** تم استخدام `this.prisma.$queryRawUnsafe` لجلب تفاصيل الحسابات بشكل جماعي، مع التأكد من أن مدخلات `IN` clause هي معرفات حسابات (UUIDs) تم جلبها من قاعدة البيانات مسبقاً، مما يقلل من مخاطر حقن SQL.
