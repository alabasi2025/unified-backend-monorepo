// SEMOP - Prisma Schema
// Smart Enterprise Management & Operations Platform
// Version: 0.2.0
// Date: 2025-11-20

generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/.prisma/client"
}

datasource db {
  provider = "postgresql"
}

// ============================================================================
// 1. MULTI-ENTITY SYSTEM (نظام الكيانات المتعددة)
// ============================================================================

/// الشركة القابضة - المستوى الأول في الهيكل الهرمي
model Holding {
  id          String  @id @default(cuid())
  code        String  @unique /// كود فريد للشركة (مثل: HOLD001)
  nameAr      String /// الاسم بالعربية
  nameEn      String /// الاسم بالإنجليزية
  description String? /// وصف الشركة
  logo        String? /// رابط شعار الشركة
  isActive    Boolean @default(true) /// هل الشركة نشطة؟

  // العلاقات
  units Unit[]
  users User[]

  // التدقيق (Audit Trail)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String?
  updatedBy String?

  @@index([code])
  @@index([isActive])
  @@map("holdings")
}

/// الوحدة - المستوى الثاني في الهيكل الهرمي
model Unit {
  id          String   @id @default(cuid())
  code        String   @unique /// كود فريد للوحدة (مثل: UNIT001)
  nameAr      String /// الاسم بالعربية
  nameEn      String /// الاسم بالإنجليزية
  description String? /// وصف الوحدة
  type        UnitType /// نوع الوحدة (فرع، قسم، شعبة، إلخ)
  isActive    Boolean  @default(true) /// هل الوحدة نشطة؟

  // العلاقات الهرمية
  holdingId String
  holding   Holding @relation(fields: [holdingId], references: [id], onDelete: Cascade)

  // العلاقات
  projects Project[]
  institutions Institution[]
  users    User[]

  // التدقيق (Audit Trail)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String?
  updatedBy String?

  @@index([code])
  @@index([holdingId])
  @@index([type])
  @@index([isActive])
  @@map("units")
}

/// المؤسسة - المستوى الثالث في الهيكل الهرمي
model Institution {
  id          String  @id @default(cuid())
  code        String  @unique /// كود فريد للمؤسسة (مثل: INST001)
  nameAr      String /// الاسم بالعربية
  nameEn      String /// الاسم بالإنجليزية
  description String? /// وصف المؤسسة
  isActive    Boolean @default(true) /// هل المؤسسة نشطة؟

  // العلاقات الهرمية
  unitId String
  unit   Unit   @relation(fields: [unitId], references: [id], onDelete: Cascade)

  // العلاقات
  accounts Account[]
  users    User[]

  // التدقيق (Audit Trail)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String?
  updatedBy String?

  @@index([code])
  @@index([unitId])
  @@index([institutionId])
  @@index([isActive])
  @@map("institutions")
}

/// أنواع الوحدات
enum UnitType {
  BRANCH /// فرع
  DEPARTMENT /// قسم
  DIVISION /// شعبة
  SUBSIDIARY /// شركة تابعة
  OTHER /// أخرى
}

/// المشروع - المستوى الثالث في الهيكل الهرمي
model Project {
  id          String        @id @default(cuid())
  code        String        @unique /// كود فريد للمشروع (مثل: PROJ001)
  nameAr      String /// الاسم بالعربية
  nameEn      String /// الاسم بالإنجليزية
  description String? /// وصف المشروع
  status      ProjectStatus /// حالة المشروع
  startDate   DateTime? /// تاريخ البدء
  endDate     DateTime? /// تاريخ الانتهاء المتوقع
  budget      Decimal?      @db.Decimal(15, 2) /// الميزانية
  isActive    Boolean       @default(true) /// هل المشروع نشط؟

  // العلاقات الهرمية
  unitId String
  unit   Unit   @relation(fields: [unitId], references: [id], onDelete: Cascade)

  // العلاقات
  users User[]

  // التدقيق (Audit Trail)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String?
  updatedBy String?

  @@index([code])
  @@index([unitId])
  @@index([institutionId])
  @@index([status])
  @@index([isActive])
  @@map("projects")
}

/// حالات المشروع
enum ProjectStatus {
  PLANNING /// تخطيط
  IN_PROGRESS /// قيد التنفيذ
  ON_HOLD /// معلق
  COMPLETED /// مكتمل
  CANCELLED /// ملغي
}

// ============================================================================
// 2. IDENTITY & ACCESS MANAGEMENT (نظام الهوية والصلاحيات)
// ============================================================================

/// المستخدم
model User {
  id              String    @id @default(cuid())
  username        String    @unique /// اسم المستخدم
  email           String    @unique /// البريد الإلكتروني
  passwordHash    String /// كلمة المرور المشفرة (bcrypt)
  firstName       String /// الاسم الأول
  lastName        String /// الاسم الأخير
  phone           String? /// رقم الهاتف
  avatar          String? /// رابط صورة المستخدم
  isActive        Boolean   @default(true) /// هل المستخدم نشط؟
  isEmailVerified Boolean   @default(false) /// هل البريد مُفعّل؟
  lastLoginAt     DateTime? /// آخر تسجيل دخول

  // العلاقات مع الكيانات (Multi-Entity Support)
  // المستخدم يمكن أن ينتمي لـ Holding أو Unit أو Project
  holdingId String?
  holding   Holding? @relation(fields: [holdingId], references: [id], onDelete: SetNull)

  unitId String?
  unit   Unit?   @relation(fields: [unitId], references: [id], onDelete: SetNull)

  institutionId String?
  institution   Institution? @relation(fields: [institutionId], references: [id], onDelete: SetNull)

  // العلاقات مع الأدوار
  userRoles UserRole[]
  
  // Magic Notebook Relations
  magicNotebooks      MagicNotebook[]
  magicSections       MagicSection[]
  magicPages          MagicPage[]
  magicChatLogs       MagicChatLog[]
  magicIdeas          MagicIdea[]
  magicTasks          MagicTask[]
  magicReports        MagicReport[]
  magicArchives       MagicArchive[]
  magicTimelineEvents MagicTimelineEvent[]
  magicStickyNotes    MagicStickyNote[]

  // التدقيق (Audit Trail)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String?
  updatedBy String?

  @@index([email])
  @@index([username])
  @@index([holdingId])
  @@index([unitId])
  @@index([institutionId])
  @@index([isActive])
  @@map("users")
}

/// الدور (Role)
model Role {
  id          String  @id @default(cuid())
  code        String  @unique /// كود الدور (مثل: SUPER_ADMIN)
  nameAr      String /// الاسم بالعربية
  nameEn      String /// الاسم بالإنجليزية
  description String? /// وصف الدور
  isSystem    Boolean @default(false) /// هل هو دور نظام (لا يمكن حذفه)
  isActive    Boolean @default(true) /// هل الدور نشط؟

  // العلاقات
  userRoles       UserRole[]
  rolePermissions RolePermission[]

  // التدقيق (Audit Trail)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([code])
  @@index([isSystem])
  @@index([isActive])
  @@map("roles")
}

/// الصلاحية (Permission)
model Permission {
  id          String  @id @default(cuid())
  code        String  @unique /// كود الصلاحية (مثل: USER_CREATE)
  nameAr      String /// الاسم بالعربية
  nameEn      String /// الاسم بالإنجليزية
  description String? /// وصف الصلاحية
  module      String /// اسم الوحدة (مثل: users, inventory)
  action      String /// الإجراء (create, read, update, delete)

  // العلاقات
  rolePermissions RolePermission[]

  // التدقيق (Audit Trail)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([module, action])
  @@index([code])
  @@index([module])
  @@map("permissions")
}

/// ربط المستخدم بالدور (Many-to-Many)
model UserRole {
  id String @id @default(cuid())

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  roleId String
  role   Role   @relation(fields: [roleId], references: [id], onDelete: Cascade)

  // التدقيق (Audit Trail)
  assignedAt DateTime @default(now())
  assignedBy String?

  @@unique([userId, roleId])
  @@index([userId])
  @@index([roleId])
  @@map("user_roles")
}

/// ربط الدور بالصلاحية (Many-to-Many)
model RolePermission {
  id String @id @default(cuid())

  roleId String
  role   Role   @relation(fields: [roleId], references: [id], onDelete: Cascade)

  permissionId String
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  // التدقيق (Audit Trail)
  assignedAt DateTime @default(now())
  assignedBy String?

  @@unique([roleId, permissionId])
  @@index([roleId])
  @@index([permissionId])
  @@map("role_permissions")
}

// ============================================================================
// 3. CONFIGURATION SYSTEM (نظام التكوين)
// ============================================================================

/// التكوين (Configuration)
model Configuration {
  id       String         @id @default(cuid())
  key      String /// مفتاح التكوين (مثل: currency, timezone)
  value    String /// القيمة (JSON string)
  dataType ConfigDataType /// نوع البيانات
  scope    ConfigScope /// نطاق التكوين

  // العلاقات مع الكيانات (اختياري حسب scope)
  holdingId String?
  unitId    String?
  projectId String?

  // الوصف
  nameAr      String
  nameEn      String
  description String?

  // التدقيق (Audit Trail)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String?
  updatedBy String?

  @@unique([key, scope, holdingId, unitId, projectId])
  @@index([key])
  @@index([scope])
  @@map("configurations")
}

/// أنواع بيانات التكوين
enum ConfigDataType {
  STRING
  NUMBER
  BOOLEAN
  JSON
  DATE
}

/// نطاق التكوين
enum ConfigScope {
  SYSTEM /// على مستوى النظام
  HOLDING /// على مستوى الشركة القابضة
  UNIT /// على مستوى الوحدة
  PROJECT /// على مستوى المشروع
}

// ============================================================================
// 4. ACCOUNTING SYSTEM - CHART OF ACCOUNTS (نظام دليل الحسابات)
// ============================================================================

/// الحساب المحاسبي
model Account {
  id               String        @id @default(cuid())
  code             String        @unique /// رمز الحساب (مثل: 1010, 2010)
  nameAr           String /// الاسم بالعربية
  nameEn           String /// الاسم بالإنجليزية
  description      String? /// وصف الحساب
  accountType      AccountType /// نوع الحساب (أصول، خصوم، إلخ)
  accountNature    AccountNature /// طبيعة الحساب (مدين، دائن)
  level            Int /// مستوى الحساب في الشجرة (1, 2, 3, ...)
  isParent         Boolean       @default(false) /// هل الحساب رئيسي (يحتوي على حسابات فرعية)
  isActive         Boolean       @default(true) /// حالة التفعيل
  allowManualEntry Boolean       @default(true) /// السماح بالقيد المباشر (false للحسابات الرئيسية)

  // العلاقات الهرمية (Self-Referencing)
  parentId String?
  parent   Account?  @relation("AccountHierarchy", fields: [parentId], references: [id], onDelete: SetNull)
  children Account[] @relation("AccountHierarchy")

  // العلاقات مع الكيانات (اختياري)
  holdingId String?
  unitId    String?

  // العلاقات
  journalEntryLines   JournalEntryLine[]
  accountBalances     AccountBalance[]
  hierarchyAsAccount  AccountHierarchy[] @relation("AccountAsAccount")
  hierarchyAsAncestor AccountHierarchy[] @relation("AccountAsAncestor")

  // Item Relations (Inventory Integration)
  itemsAsSalesAccount     Item[] @relation("ItemSalesAccount")
  itemsAsPurchaseAccount  Item[] @relation("ItemPurchaseAccount")
  itemsAsInventoryAccount Item[] @relation("ItemInventoryAccount")

  // التدقيق (Audit Trail)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String?
  updatedBy String?

  @@index([code])
  @@index([accountType])
  @@index([parentId])
  @@index([holdingId])
  @@index([unitId])
  @@index([institutionId])
  @@index([isActive])
  @@index([allowManualEntry])
  @@map("accounts")
}

/// نوع الحساب
enum AccountType {
  ASSET /// أصول
  LIABILITY /// خصوم (التزامات)
  EQUITY /// حقوق ملكية
  REVENUE /// إيرادات
  EXPENSE /// مصروفات
}

/// طبيعة الحساب
enum AccountNature {
  DEBIT /// مدين (الأصول والمصروفات)
  CREDIT /// دائن (الخصوم وحقوق الملكية والإيرادات)
}

/// أرصدة الحسابات
model AccountBalance {
  id String @id @default(cuid())

  accountId String
  account   Account @relation(fields: [accountId], references: [id], onDelete: Cascade)

  fiscalYearId String
  fiscalYear   FiscalYear @relation(fields: [fiscalYearId], references: [id], onDelete: Cascade)

  openingBalance Decimal @default(0) @db.Decimal(15, 2) /// الرصيد الافتتاحي
  closingBalance Decimal @default(0) @db.Decimal(15, 2) /// الرصيد الختامي
  debitTotal     Decimal @default(0) @db.Decimal(15, 2) /// إجمالي المدين
  creditTotal    Decimal @default(0) @db.Decimal(15, 2) /// إجمالي الدائن

  // التدقيق (Audit Trail)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([accountId, fiscalYearId])
  @@index([accountId])
  @@index([fiscalYearId])
  @@map("account_balances")
}

/// التسلسل الهرمي للحسابات (Materialized Path)
model AccountHierarchy {
  id String @id @default(cuid())

  accountId String
  account   Account @relation("AccountAsAccount", fields: [accountId], references: [id], onDelete: Cascade)

  ancestorId String
  ancestor   Account @relation("AccountAsAncestor", fields: [ancestorId], references: [id], onDelete: Cascade)

  depth Int /// عمق العلاقة (0 للحساب نفسه، 1 للأب المباشر، إلخ)

  @@index([accountId, ancestorId])
  @@index([accountId])
  @@index([ancestorId])
  @@map("account_hierarchy")
}

// ============================================================================
// 5. ACCOUNTING SYSTEM - JOURNAL ENTRIES (نظام القيود اليومية)
// ============================================================================

/// القيد المحاسبي (رأس القيد)
model JournalEntry {
  id          String             @id @default(cuid())
  entryNumber String             @unique /// رقم القيد (مثل: JE-2025-0001)
  entryDate   DateTime /// تاريخ القيد
  description String /// وصف القيد
  reference   String? /// مرجع خارجي (رقم فاتورة، شيك، إلخ)
  entryType   JournalEntryType /// نوع القيد
  status      JournalEntryStatus @default(DRAFT) /// حالة القيد
  totalDebit  Decimal            @default(0) @db.Decimal(15, 2) /// إجمالي المدين
  totalCredit Decimal            @default(0) @db.Decimal(15, 2) /// إجمالي الدائن
  isBalanced  Boolean            @default(false) /// هل القيد متوازن (Computed)

  // الترحيل والعكس
  postedAt   DateTime? /// تاريخ الترحيل
  postedBy   String? /// من قام بالترحيل
  reversedAt DateTime? /// تاريخ العكس
  reversedBy String? /// من قام بالعكس

  // العلاقة مع القيد المعكوس
  reversalOfId String?
  reversalOf   JournalEntry?  @relation("ReversalRelation", fields: [reversalOfId], references: [id], onDelete: SetNull)
  reversals    JournalEntry[] @relation("ReversalRelation")

  // العلاقات مع الكيانات
  fiscalYearId String
  fiscalYear   FiscalYear @relation(fields: [fiscalYearId], references: [id], onDelete: Restrict)

  holdingId String?
  unitId    String?
  projectId String?

  // العلاقات
  lines JournalEntryLine[]

  // Invoice Relations
  purchaseInvoices PurchaseInvoice[]
  purchaseReturns  PurchaseReturn[]
  salesInvoices    SalesInvoice[]
  salesReturns     SalesReturn[]

  // التدقيق (Audit Trail)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String?
  updatedBy String?

  @@index([entryNumber])
  @@index([entryDate])
  @@index([status])
  @@index([fiscalYearId])
  @@index([holdingId])
  @@index([unitId])
  @@index([institutionId])
  @@map("journal_entries")
}

/// نوع القيد
enum JournalEntryType {
  OPENING /// قيد افتتاحي
  REGULAR /// قيد عادي
  CLOSING /// قيد إقفال
  ADJUSTMENT /// قيد تسوية
}

/// حالة القيد
enum JournalEntryStatus {
  DRAFT /// مسودة (قابل للتعديل)
  POSTED /// مرحّل (غير قابل للتعديل)
  REVERSED /// معكوس
}

/// سطر القيد المحاسبي
model JournalEntryLine {
  id String @id @default(cuid())

  journalEntryId String
  journalEntry   JournalEntry @relation(fields: [journalEntryId], references: [id], onDelete: Cascade)

  lineNumber Int /// رقم السطر (1, 2, 3, ...)

  accountId String
  account   Account @relation(fields: [accountId], references: [id], onDelete: Restrict)

  description String /// وصف السطر
  debit       Decimal @default(0) @db.Decimal(15, 2) /// المبلغ المدين
  credit      Decimal @default(0) @db.Decimal(15, 2) /// المبلغ الدائن

  // مركز التكلفة (اختياري)
  costCenterId String?
  costCenter   CostCenter? @relation(fields: [costCenterId], references: [id], onDelete: SetNull)

  // التدقيق (Audit Trail)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([journalEntryId, lineNumber])
  @@index([journalEntryId])
  @@index([accountId])
  @@index([costCenterId])
  @@map("journal_entry_lines")
}

// ============================================================================
// 6. ACCOUNTING SYSTEM - COST CENTERS (نظام مراكز التكلفة)
// ============================================================================

/// مركز التكلفة
model CostCenter {
  id          String  @id @default(cuid())
  code        String  @unique /// رمز مركز التكلفة
  nameAr      String /// الاسم بالعربية
  nameEn      String /// الاسم بالإنجليزية
  description String? /// الوصف
  isActive    Boolean @default(true) /// حالة التفعيل

  // العلاقات الهرمية (Self-Referencing)
  parentId String?
  parent   CostCenter?  @relation("CostCenterHierarchy", fields: [parentId], references: [id], onDelete: SetNull)
  children CostCenter[] @relation("CostCenterHierarchy")

  // العلاقات مع الكيانات (اختياري)
  holdingId String?
  unitId    String?
  projectId String?

  // العلاقات
  journalEntryLines JournalEntryLine[]

  // التدقيق (Audit Trail)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String?
  updatedBy String?

  @@index([code])
  @@index([parentId])
  @@index([holdingId])
  @@index([unitId])
  @@index([institutionId])
  @@index([isActive])
  @@map("cost_centers")
}

// ============================================================================
// 7. ACCOUNTING SYSTEM - FISCAL YEARS (نظام السنوات المالية)
// ============================================================================

/// السنة المالية
model FiscalYear {
  id        String           @id @default(cuid())
  code      String           @unique /// رمز السنة المالية (مثل: FY-2025)
  nameAr    String /// الاسم بالعربية
  nameEn    String /// الاسم بالإنجليزية
  startDate DateTime /// تاريخ بداية السنة المالية
  endDate   DateTime /// تاريخ نهاية السنة المالية
  status    FiscalYearStatus @default(OPEN) /// حالة السنة
  isCurrent Boolean          @default(false) /// هل هي السنة الحالية

  // العلاقات مع الكيانات (اختياري)
  holdingId String?

  // العلاقات
  periods         FiscalPeriod[]
  journalEntries  JournalEntry[]
  accountBalances AccountBalance[]

  // التدقيق (Audit Trail)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String?
  updatedBy String?

  @@index([code])
  @@index([startDate])
  @@index([endDate])
  @@index([status])
  @@index([isCurrent])
  @@index([holdingId])
  @@map("fiscal_years")
}

/// حالة السنة المالية
enum FiscalYearStatus {
  OPEN /// مفتوحة (قابلة للقيد)
  CLOSED /// مغلقة (غير قابلة للقيد)
  LOCKED /// مقفلة (مغلقة نهائياً)
}

/// الفترة المحاسبية
model FiscalPeriod {
  id String @id @default(cuid())

  fiscalYearId String
  fiscalYear   FiscalYear @relation(fields: [fiscalYearId], references: [id], onDelete: Cascade)

  periodNumber Int /// رقم الفترة (1-12 للشهور)
  nameAr       String /// الاسم بالعربية (يناير، فبراير، ...)
  nameEn       String /// الاسم بالإنجليزية (January, February, ...)
  startDate    DateTime /// تاريخ بداية الفترة
  endDate      DateTime /// تاريخ نهاية الفترة
  status       FiscalPeriodStatus @default(OPEN) /// حالة الفترة

  // التدقيق (Audit Trail)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([fiscalYearId, periodNumber])
  @@index([fiscalYearId])
  @@index([status])
  @@index([startDate])
  @@index([endDate])
  @@map("fiscal_periods")
}

/// حالة الفترة المحاسبية
enum FiscalPeriodStatus {
  OPEN /// مفتوحة
  CLOSED /// مغلقة
}

// ============================================================================
// 6. SUPPLIERS SYSTEM (نظام الموردين)
// ============================================================================

/// فئات الموردين
model SupplierCategory {
  id          String  @id @default(cuid())
  code        String  @unique
  nameAr      String
  nameEn      String
  description String?
  isActive    Boolean @default(true)

  // Relations
  suppliers Supplier[]

  // Audit Trail
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String?
  updatedBy String?

  @@index([code])
  @@index([isActive])
  @@map("supplier_categories")
}

/// الموردين
model Supplier {
  id                 String  @id @default(cuid())
  code               String  @unique
  nameAr             String
  nameEn             String
  taxNumber          String? @unique
  commercialRegister String?
  email              String?
  phone              String?
  website            String?
  paymentTerms       Int     @default(30) /// أيام الدفع
  creditLimit        Decimal @default(0) @db.Decimal(15, 2)
  currentBalance     Decimal @default(0) @db.Decimal(15, 2)
  isActive           Boolean @default(true)

  // Relations
  categoryId String?
  category   SupplierCategory? @relation(fields: [categoryId], references: [id], onDelete: SetNull)

  // Multi-Entity Support
  holdingId String?
  unitId    String?

  // Relations
  addresses        SupplierAddress[]
  contacts         SupplierContact[]
  purchaseOrders   PurchaseOrder[]
  purchaseInvoices PurchaseInvoice[]
  purchaseReturns  PurchaseReturn[]

  // Audit Trail
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String?
  updatedBy String?

  @@index([code])
  @@index([taxNumber])
  @@index([email])
  @@index([categoryId])
  @@index([holdingId])
  @@index([unitId])
  @@index([institutionId])
  @@index([isActive])
  @@map("suppliers")
}

enum AddressType {
  BILLING
  SHIPPING
  BOTH
}

/// عناوين الموردين
model SupplierAddress {
  id         String   @id @default(cuid())
  supplierId String
  supplier   Supplier @relation(fields: [supplierId], references: [id], onDelete: Cascade)

  addressType    AddressType
  country        String
  city           String
  district       String?
  street         String?
  buildingNumber String?
  postalCode     String?
  isPrimary      Boolean     @default(false)

  // Audit Trail
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([supplierId])
  @@index([addressType])
  @@index([isPrimary])
  @@map("supplier_addresses")
}

/// جهات اتصال الموردين
model SupplierContact {
  id         String   @id @default(cuid())
  supplierId String
  supplier   Supplier @relation(fields: [supplierId], references: [id], onDelete: Cascade)

  name      String
  position  String?
  email     String?
  phone     String?
  mobile    String?
  isPrimary Boolean @default(false)

  // Audit Trail
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([supplierId])
  @@index([isPrimary])
  @@map("supplier_contacts")
}

// ============================================================================
// 7. CUSTOMERS SYSTEM (نظام العملاء)
// ============================================================================

/// فئات العملاء
model CustomerCategory {
  id                 String  @id @default(cuid())
  code               String  @unique
  nameAr             String
  nameEn             String
  description        String?
  discountPercentage Decimal @default(0) @db.Decimal(5, 2)
  isActive           Boolean @default(true)

  // Relations
  customers Customer[]

  // Audit Trail
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String?
  updatedBy String?

  @@index([code])
  @@index([isActive])
  @@map("customer_categories")
}

/// العملاء
model Customer {
  id                 String  @id @default(cuid())
  code               String  @unique
  nameAr             String
  nameEn             String
  taxNumber          String? @unique
  commercialRegister String?
  email              String?
  phone              String?
  website            String?
  paymentTerms       Int     @default(30)
  creditLimit        Decimal @default(0) @db.Decimal(15, 2)
  currentBalance     Decimal @default(0) @db.Decimal(15, 2)
  isActive           Boolean @default(true)

  // Relations
  categoryId String?
  category   CustomerCategory? @relation(fields: [categoryId], references: [id], onDelete: SetNull)

  // Multi-Entity Support
  holdingId String?
  unitId    String?

  // Relations
  addresses     CustomerAddress[]
  contacts      CustomerContact[]
  salesOrders   SalesOrder[]
  salesInvoices SalesInvoice[]
  salesReturns  SalesReturn[]

  // Audit Trail
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String?
  updatedBy String?

  @@index([code])
  @@index([taxNumber])
  @@index([email])
  @@index([categoryId])
  @@index([holdingId])
  @@index([unitId])
  @@index([institutionId])
  @@index([isActive])
  @@map("customers")
}

/// عناوين العملاء
model CustomerAddress {
  id         String   @id @default(cuid())
  customerId String
  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  addressType    AddressType
  country        String
  city           String
  district       String?
  street         String?
  buildingNumber String?
  postalCode     String?
  isPrimary      Boolean     @default(false)

  // Audit Trail
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([customerId])
  @@index([addressType])
  @@index([isPrimary])
  @@map("customer_addresses")
}

/// جهات اتصال العملاء
model CustomerContact {
  id         String   @id @default(cuid())
  customerId String
  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  name      String
  position  String?
  email     String?
  phone     String?
  mobile    String?
  isPrimary Boolean @default(false)

  // Audit Trail
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([customerId])
  @@index([isPrimary])
  @@map("customer_contacts")
}

// ============================================================================
// 8. INVENTORY SYSTEM (نظام المخزون)
// ============================================================================

/// فئات الأصناف
model ItemCategory {
  id          String  @id @default(cuid())
  code        String  @unique
  nameAr      String
  nameEn      String
  description String?
  isActive    Boolean @default(true)

  // Self-Referencing (Hierarchical)
  parentId String?
  parent   ItemCategory?  @relation("ItemCategoryHierarchy", fields: [parentId], references: [id], onDelete: SetNull)
  children ItemCategory[] @relation("ItemCategoryHierarchy")

  // Relations
  items Item[]

  // Audit Trail
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String?
  updatedBy String?

  @@index([code])
  @@index([parentId])
  @@index([isActive])
  @@map("item_categories")
}

enum ItemType {
  PRODUCT /// منتج
  SERVICE /// خدمة
  MATERIAL /// مادة خام
}

/// الأصناف
model Item {
  id          String   @id @default(cuid())
  code        String   @unique
  barcode     String?  @unique
  nameAr      String
  nameEn      String
  description String?
  itemType    ItemType
  unit        String /// وحدة القياس

  // Pricing
  costPrice       Decimal  @default(0) @db.Decimal(15, 2)
  sellingPrice    Decimal  @default(0) @db.Decimal(15, 2)
  minSellingPrice Decimal? @db.Decimal(15, 2)

  // Stock
  reorderLevel  Decimal? @db.Decimal(10, 2)
  maxStockLevel Decimal? @db.Decimal(10, 2)

  // Flags
  isActive      Boolean @default(true)
  isSellable    Boolean @default(true)
  isPurchasable Boolean @default(true)
  isStockable   Boolean @default(true)

  // Relations
  categoryId String?
  category   ItemCategory? @relation(fields: [categoryId], references: [id], onDelete: SetNull)

  // Accounting Integration
  salesAccountId String?
  salesAccount   Account? @relation("ItemSalesAccount", fields: [salesAccountId], references: [id], onDelete: SetNull)

  purchaseAccountId String?
  purchaseAccount   Account? @relation("ItemPurchaseAccount", fields: [purchaseAccountId], references: [id], onDelete: SetNull)

  inventoryAccountId String?
  inventoryAccount   Account? @relation("ItemInventoryAccount", fields: [inventoryAccountId], references: [id], onDelete: SetNull)

  // Multi-Entity Support
  holdingId String?

  // Relations
  stockLevels          StockLevel[]
  stockMovements       StockMovement[]
  purchaseOrderLines   PurchaseOrderLine[]
  purchaseInvoiceLines PurchaseInvoiceLine[]
  salesOrderLines      SalesOrderLine[]
  salesInvoiceLines    SalesInvoiceLine[]
  stockCountLines      StockCountLine[]

  // Audit Trail
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String?
  updatedBy String?

  @@index([code])
  @@index([barcode])
  @@index([itemType])
  @@index([categoryId])
  @@index([salesAccountId])
  @@index([purchaseAccountId])
  @@index([inventoryAccountId])
  @@index([holdingId])
  @@index([isActive])
  @@index([isSellable])
  @@index([isPurchasable])
  @@index([isStockable])
  @@map("items")
}

/// المخازن
model Warehouse {
  id          String  @id @default(cuid())
  code        String  @unique
  nameAr      String
  nameEn      String
  description String?
  location    String?
  isActive    Boolean @default(true)

  // Multi-Entity Support
  holdingId String?
  unitId    String?

  // Relations
  stockLevels          StockLevel[]
  stockMovements       StockMovement[]
  stockCounts          StockCount[]
  purchaseInvoiceLines PurchaseInvoiceLine[]
  salesInvoiceLines    SalesInvoiceLine[]

  // Audit Trail
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String?
  updatedBy String?

  @@index([code])
  @@index([holdingId])
  @@index([unitId])
  @@index([institutionId])
  @@index([isActive])
  @@map("warehouses")
}

/// مستويات المخزون
model StockLevel {
  id String @id @default(cuid())

  itemId String
  item   Item   @relation(fields: [itemId], references: [id], onDelete: Cascade)

  warehouseId String
  warehouse   Warehouse @relation(fields: [warehouseId], references: [id], onDelete: Cascade)

  quantity          Decimal @default(0) @db.Decimal(10, 2)
  reservedQuantity  Decimal @default(0) @db.Decimal(10, 2)
  availableQuantity Decimal @default(0) @db.Decimal(10, 2)

  // Audit Trail
  updatedAt DateTime @updatedAt

  @@unique([itemId, warehouseId])
  @@index([itemId])
  @@index([warehouseId])
  @@map("stock_levels")
}

enum StockMovementType {
  PURCHASE_RECEIPT /// استلام شراء
  SALES_ISSUE /// صرف مبيعات
  TRANSFER_IN /// تحويل وارد
  TRANSFER_OUT /// تحويل صادر
  ADJUSTMENT_IN /// تسوية إضافة
  ADJUSTMENT_OUT /// تسوية خصم
  OPENING_BALANCE /// رصيد افتتاحي
  RETURN_FROM_CUSTOMER /// مرتجع من عميل
  RETURN_TO_SUPPLIER /// مرتجع لمورد
}

/// حركات المخزون
model StockMovement {
  id             String            @id @default(cuid())
  movementNumber String            @unique
  movementDate   DateTime
  movementType   StockMovementType

  itemId String
  item   Item   @relation(fields: [itemId], references: [id], onDelete: Restrict)

  warehouseId String
  warehouse   Warehouse @relation(fields: [warehouseId], references: [id], onDelete: Restrict)

  quantity  Decimal  @db.Decimal(10, 2)
  unitCost  Decimal? @db.Decimal(15, 2)
  totalCost Decimal? @db.Decimal(15, 2)

  reference String?
  notes     String?

  // Relations (optional based on movement type)
  purchaseInvoiceLineId String?
  salesInvoiceLineId    String?

  // Audit Trail
  createdAt DateTime @default(now())
  createdBy String?

  @@index([movementNumber])
  @@index([movementDate])
  @@index([movementType])
  @@index([itemId])
  @@index([warehouseId])
  @@map("stock_movements")
}

enum StockCountStatus {
  DRAFT
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

/// الجرد
model StockCount {
  id          String           @id @default(cuid())
  countNumber String           @unique
  countDate   DateTime
  status      StockCountStatus

  warehouseId String
  warehouse   Warehouse @relation(fields: [warehouseId], references: [id], onDelete: Restrict)

  notes String?

  // Relations
  lines StockCountLine[]

  // Audit Trail
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  createdBy   String?
  updatedBy   String?
  completedAt DateTime?
  completedBy String?

  @@index([countNumber])
  @@index([countDate])
  @@index([status])
  @@index([warehouseId])
  @@map("stock_counts")
}

/// سطور الجرد
model StockCountLine {
  id String @id @default(cuid())

  stockCountId String
  stockCount   StockCount @relation(fields: [stockCountId], references: [id], onDelete: Cascade)

  itemId String
  item   Item   @relation(fields: [itemId], references: [id], onDelete: Restrict)

  systemQuantity  Decimal @db.Decimal(10, 2)
  countedQuantity Decimal @db.Decimal(10, 2)
  difference      Decimal @db.Decimal(10, 2)

  notes String?

  // Audit Trail
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([stockCountId])
  @@index([itemId])
  @@map("stock_count_lines")
}

// ============================================================================
// 9. PURCHASES SYSTEM (نظام المشتريات)
// ============================================================================

enum PurchaseOrderStatus {
  DRAFT
  PENDING
  APPROVED
  PARTIALLY_RECEIVED
  RECEIVED
  CANCELLED
}

/// طلبات الشراء
model PurchaseOrder {
  id                   String              @id @default(cuid())
  orderNumber          String              @unique
  orderDate            DateTime
  expectedDeliveryDate DateTime?
  status               PurchaseOrderStatus

  supplierId String
  supplier   Supplier @relation(fields: [supplierId], references: [id], onDelete: Restrict)

  subtotal       Decimal @default(0) @db.Decimal(15, 2)
  taxAmount      Decimal @default(0) @db.Decimal(15, 2)
  discountAmount Decimal @default(0) @db.Decimal(15, 2)
  totalAmount    Decimal @default(0) @db.Decimal(15, 2)

  notes String?

  // Multi-Entity Support
  holdingId String?
  unitId    String?
  projectId String?

  // Relations
  lines    PurchaseOrderLine[]
  invoices PurchaseInvoice[]

  // Audit Trail
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  createdBy  String?
  updatedBy  String?
  approvedAt DateTime?
  approvedBy String?

  @@index([orderNumber])
  @@index([orderDate])
  @@index([status])
  @@index([supplierId])
  @@index([holdingId])
  @@index([unitId])
  @@index([institutionId])
  @@map("purchase_orders")
}

/// سطور طلبات الشراء
model PurchaseOrderLine {
  id String @id @default(cuid())

  purchaseOrderId String
  purchaseOrder   PurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)

  lineNumber Int

  itemId String
  item   Item   @relation(fields: [itemId], references: [id], onDelete: Restrict)

  description  String?
  quantity     Decimal @db.Decimal(10, 2)
  unitPrice    Decimal @db.Decimal(15, 2)
  taxRate      Decimal @default(15) @db.Decimal(5, 2)
  discountRate Decimal @default(0) @db.Decimal(5, 2)

  // Computed Fields
  lineTotal      Decimal @db.Decimal(15, 2)
  taxAmount      Decimal @db.Decimal(15, 2)
  discountAmount Decimal @db.Decimal(15, 2)
  netAmount      Decimal @db.Decimal(15, 2)

  receivedQuantity Decimal @default(0) @db.Decimal(10, 2)

  // Audit Trail
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([purchaseOrderId, lineNumber])
  @@index([purchaseOrderId])
  @@index([itemId])
  @@map("purchase_order_lines")
}

enum PurchaseInvoiceStatus {
  DRAFT
  POSTED
  PARTIALLY_PAID
  PAID
  CANCELLED
}

/// فواتير الشراء
model PurchaseInvoice {
  id                    String                @id @default(cuid())
  invoiceNumber         String                @unique
  supplierInvoiceNumber String?
  invoiceDate           DateTime
  dueDate               DateTime?
  status                PurchaseInvoiceStatus

  supplierId String
  supplier   Supplier @relation(fields: [supplierId], references: [id], onDelete: Restrict)

  purchaseOrderId String?
  purchaseOrder   PurchaseOrder? @relation(fields: [purchaseOrderId], references: [id], onDelete: SetNull)

  subtotal        Decimal @default(0) @db.Decimal(15, 2)
  taxAmount       Decimal @default(0) @db.Decimal(15, 2)
  discountAmount  Decimal @default(0) @db.Decimal(15, 2)
  totalAmount     Decimal @default(0) @db.Decimal(15, 2)
  paidAmount      Decimal @default(0) @db.Decimal(15, 2)
  remainingAmount Decimal @default(0) @db.Decimal(15, 2)

  notes String?

  // Multi-Entity Support
  holdingId String?
  unitId    String?
  projectId String?

  // Accounting Integration
  journalEntryId String?
  journalEntry   JournalEntry? @relation(fields: [journalEntryId], references: [id], onDelete: SetNull)

  // Relations
  lines   PurchaseInvoiceLine[]
  returns PurchaseReturn[]

  // Audit Trail
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  createdBy String?
  updatedBy String?
  postedAt  DateTime?
  postedBy  String?

  @@index([invoiceNumber])
  @@index([invoiceDate])
  @@index([status])
  @@index([supplierId])
  @@index([purchaseOrderId])
  @@index([journalEntryId])
  @@index([holdingId])
  @@index([unitId])
  @@index([institutionId])
  @@map("purchase_invoices")
}

/// سطور فواتير الشراء
model PurchaseInvoiceLine {
  id String @id @default(cuid())

  purchaseInvoiceId String
  purchaseInvoice   PurchaseInvoice @relation(fields: [purchaseInvoiceId], references: [id], onDelete: Cascade)

  lineNumber Int

  itemId String
  item   Item   @relation(fields: [itemId], references: [id], onDelete: Restrict)

  warehouseId String
  warehouse   Warehouse @relation(fields: [warehouseId], references: [id], onDelete: Restrict)

  description  String?
  quantity     Decimal @db.Decimal(10, 2)
  unitPrice    Decimal @db.Decimal(15, 2)
  taxRate      Decimal @default(15) @db.Decimal(5, 2)
  discountRate Decimal @default(0) @db.Decimal(5, 2)

  // Computed Fields
  lineTotal      Decimal @db.Decimal(15, 2)
  taxAmount      Decimal @db.Decimal(15, 2)
  discountAmount Decimal @db.Decimal(15, 2)
  netAmount      Decimal @db.Decimal(15, 2)

  // Audit Trail
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([purchaseInvoiceId, lineNumber])
  @@index([purchaseInvoiceId])
  @@index([itemId])
  @@index([warehouseId])
  @@map("purchase_invoice_lines")
}

enum PurchaseReturnStatus {
  DRAFT
  POSTED
  CANCELLED
}

/// مرتجعات الشراء
model PurchaseReturn {
  id           String               @id @default(cuid())
  returnNumber String               @unique
  returnDate   DateTime
  status       PurchaseReturnStatus

  supplierId String
  supplier   Supplier @relation(fields: [supplierId], references: [id], onDelete: Restrict)

  purchaseInvoiceId String
  purchaseInvoice   PurchaseInvoice @relation(fields: [purchaseInvoiceId], references: [id], onDelete: Restrict)

  totalAmount Decimal @default(0) @db.Decimal(15, 2)

  reason String?
  notes  String?

  // Multi-Entity Support
  holdingId String?
  unitId    String?

  // Accounting Integration
  journalEntryId String?
  journalEntry   JournalEntry? @relation(fields: [journalEntryId], references: [id], onDelete: SetNull)

  // Relations
  lines PurchaseReturnLine[]

  // Audit Trail
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String?
  updatedBy String?

  @@index([returnNumber])
  @@index([returnDate])
  @@index([status])
  @@index([supplierId])
  @@index([purchaseInvoiceId])
  @@index([journalEntryId])
  @@index([holdingId])
  @@index([unitId])
  @@index([institutionId])
  @@map("purchase_returns")
}

/// سطور مرتجعات الشراء
model PurchaseReturnLine {
  id String @id @default(cuid())

  purchaseReturnId String
  purchaseReturn   PurchaseReturn @relation(fields: [purchaseReturnId], references: [id], onDelete: Cascade)

  lineNumber Int

  itemId String

  warehouseId String

  description String?
  quantity    Decimal @db.Decimal(10, 2)
  unitPrice   Decimal @db.Decimal(15, 2)
  taxRate     Decimal @default(15) @db.Decimal(5, 2)

  // Computed Fields
  lineTotal Decimal @db.Decimal(15, 2)
  taxAmount Decimal @db.Decimal(15, 2)
  netAmount Decimal @db.Decimal(15, 2)

  // Audit Trail
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([purchaseReturnId, lineNumber])
  @@index([purchaseReturnId])
  @@index([itemId])
  @@index([warehouseId])
  @@map("purchase_return_lines")
}

// ============================================================================
// 10. SALES SYSTEM (نظام المبيعات)
// ============================================================================

enum SalesOrderStatus {
  DRAFT
  PENDING
  APPROVED
  PARTIALLY_INVOICED
  INVOICED
  CANCELLED
}

/// طلبات المبيعات / عروض الأسعار
model SalesOrder {
  id                   String           @id @default(cuid())
  orderNumber          String           @unique
  orderDate            DateTime
  expectedDeliveryDate DateTime?
  status               SalesOrderStatus

  customerId String
  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Restrict)

  subtotal       Decimal @default(0) @db.Decimal(15, 2)
  taxAmount      Decimal @default(0) @db.Decimal(15, 2)
  discountAmount Decimal @default(0) @db.Decimal(15, 2)
  totalAmount    Decimal @default(0) @db.Decimal(15, 2)

  notes String?

  // Multi-Entity Support
  holdingId String?
  unitId    String?
  projectId String?

  // Relations
  lines    SalesOrderLine[]
  invoices SalesInvoice[]

  // Audit Trail
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  createdBy  String?
  updatedBy  String?
  approvedAt DateTime?
  approvedBy String?

  @@index([orderNumber])
  @@index([orderDate])
  @@index([status])
  @@index([customerId])
  @@index([holdingId])
  @@index([unitId])
  @@index([institutionId])
  @@map("sales_orders")
}

/// سطور طلبات المبيعات
model SalesOrderLine {
  id String @id @default(cuid())

  salesOrderId String
  salesOrder   SalesOrder @relation(fields: [salesOrderId], references: [id], onDelete: Cascade)

  lineNumber Int

  itemId String
  item   Item   @relation(fields: [itemId], references: [id], onDelete: Restrict)

  description  String?
  quantity     Decimal @db.Decimal(10, 2)
  unitPrice    Decimal @db.Decimal(15, 2)
  taxRate      Decimal @default(15) @db.Decimal(5, 2)
  discountRate Decimal @default(0) @db.Decimal(5, 2)

  // Computed Fields
  lineTotal      Decimal @db.Decimal(15, 2)
  taxAmount      Decimal @db.Decimal(15, 2)
  discountAmount Decimal @db.Decimal(15, 2)
  netAmount      Decimal @db.Decimal(15, 2)

  invoicedQuantity Decimal @default(0) @db.Decimal(10, 2)

  // Audit Trail
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([salesOrderId, lineNumber])
  @@index([salesOrderId])
  @@index([itemId])
  @@map("sales_order_lines")
}

enum SalesInvoiceStatus {
  DRAFT
  POSTED
  PARTIALLY_PAID
  PAID
  CANCELLED
}

/// فواتير المبيعات
model SalesInvoice {
  id            String             @id @default(cuid())
  invoiceNumber String             @unique
  invoiceDate   DateTime
  dueDate       DateTime?
  status        SalesInvoiceStatus

  customerId String
  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Restrict)

  salesOrderId String?
  salesOrder   SalesOrder? @relation(fields: [salesOrderId], references: [id], onDelete: SetNull)

  subtotal        Decimal @default(0) @db.Decimal(15, 2)
  taxAmount       Decimal @default(0) @db.Decimal(15, 2)
  discountAmount  Decimal @default(0) @db.Decimal(15, 2)
  totalAmount     Decimal @default(0) @db.Decimal(15, 2)
  paidAmount      Decimal @default(0) @db.Decimal(15, 2)
  remainingAmount Decimal @default(0) @db.Decimal(15, 2)

  notes String?

  // Multi-Entity Support
  holdingId String?
  unitId    String?
  projectId String?

  // Accounting Integration
  journalEntryId String?
  journalEntry   JournalEntry? @relation(fields: [journalEntryId], references: [id], onDelete: SetNull)

  // Relations
  lines   SalesInvoiceLine[]
  returns SalesReturn[]

  // Audit Trail
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  createdBy String?
  updatedBy String?
  postedAt  DateTime?
  postedBy  String?

  @@index([invoiceNumber])
  @@index([invoiceDate])
  @@index([status])
  @@index([customerId])
  @@index([salesOrderId])
  @@index([journalEntryId])
  @@index([holdingId])
  @@index([unitId])
  @@index([institutionId])
  @@map("sales_invoices")
}

/// سطور فواتير المبيعات
model SalesInvoiceLine {
  id String @id @default(cuid())

  salesInvoiceId String
  salesInvoice   SalesInvoice @relation(fields: [salesInvoiceId], references: [id], onDelete: Cascade)

  lineNumber Int

  itemId String
  item   Item   @relation(fields: [itemId], references: [id], onDelete: Restrict)

  warehouseId String
  warehouse   Warehouse @relation(fields: [warehouseId], references: [id], onDelete: Restrict)

  description  String?
  quantity     Decimal @db.Decimal(10, 2)
  unitPrice    Decimal @db.Decimal(15, 2)
  taxRate      Decimal @default(15) @db.Decimal(5, 2)
  discountRate Decimal @default(0) @db.Decimal(5, 2)

  // Computed Fields
  lineTotal      Decimal @db.Decimal(15, 2)
  taxAmount      Decimal @db.Decimal(15, 2)
  discountAmount Decimal @db.Decimal(15, 2)
  netAmount      Decimal @db.Decimal(15, 2)

  // Audit Trail
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([salesInvoiceId, lineNumber])
  @@index([salesInvoiceId])
  @@index([itemId])
  @@index([warehouseId])
  @@map("sales_invoice_lines")
}

enum SalesReturnStatus {
  DRAFT
  POSTED
  CANCELLED
}

/// مرتجعات المبيعات
model SalesReturn {
  id           String            @id @default(cuid())
  returnNumber String            @unique
  returnDate   DateTime
  status       SalesReturnStatus

  customerId String
  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Restrict)

  salesInvoiceId String
  salesInvoice   SalesInvoice @relation(fields: [salesInvoiceId], references: [id], onDelete: Restrict)

  totalAmount Decimal @default(0) @db.Decimal(15, 2)

  reason String?
  notes  String?

  // Multi-Entity Support
  holdingId String?
  unitId    String?

  // Accounting Integration
  journalEntryId String?
  journalEntry   JournalEntry? @relation(fields: [journalEntryId], references: [id], onDelete: SetNull)

  // Relations
  lines SalesReturnLine[]

  // Audit Trail
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String?
  updatedBy String?

  @@index([returnNumber])
  @@index([returnDate])
  @@index([status])
  @@index([customerId])
  @@index([salesInvoiceId])
  @@index([journalEntryId])
  @@index([holdingId])
  @@index([unitId])
  @@index([institutionId])
  @@map("sales_returns")
}

/// سطور مرتجعات المبيعات
model SalesReturnLine {
  id String @id @default(cuid())

  salesReturnId String
  salesReturn   SalesReturn @relation(fields: [salesReturnId], references: [id], onDelete: Cascade)

  lineNumber Int

  itemId String

  warehouseId String

  description String?
  quantity    Decimal @db.Decimal(10, 2)
  unitPrice   Decimal @db.Decimal(15, 2)
  taxRate     Decimal @default(15) @db.Decimal(5, 2)

  // Computed Fields
  lineTotal Decimal @db.Decimal(15, 2)
  taxAmount Decimal @db.Decimal(15, 2)
  netAmount Decimal @db.Decimal(15, 2)

  // Audit Trail
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([salesReturnId, lineNumber])
  @@index([salesReturnId])
  @@index([itemId])
  @@index([warehouseId])
  @@map("sales_return_lines")
}

// ============================================================================

/// صفحات التوثيق - النظام الأساسي لجميع أنواع المحتوى
model DocumentationPage {
  id      String  @id @default(cuid())
  slug    String  @unique /// معرف فريد للصفحة (URL-friendly)
  title   String /// عنوان الصفحة
  content String  @db.Text /// المحتوى (Markdown)
  summary String? /// ملخص قصير

  // التنظيم الهرمي
  parentId String?
  parent   DocumentationPage?  @relation("PageHierarchy", fields: [parentId], references: [id], onDelete: Cascade)
  children DocumentationPage[] @relation("PageHierarchy")
  order    Int                 @default(0) /// ترتيب الصفحة ضمن المستوى

  // التصنيف
  type     PageType /// نوع الصفحة
  category String /// التصنيف الرئيسي
  tags     String[] /// وسوم للبحث والتصنيف

  // الحالة والنشر
  status      PageStatus @default(DRAFT) /// حالة الصفحة
  isPublished Boolean    @default(false) /// هل منشورة؟
  isFavorite  Boolean    @default(false) /// مميزة بنجمة؟
  version     String     @default("1.0.0") /// رقم الإصدار

  // الإحصائيات
  viewCount Int @default(0) /// عدد المشاهدات

  // العلاقات
  tasks      Task[]
  ideas      Idea[]
  chatLogs   ChatLog[]
  reports    Report[]
  links      PageLink[]    @relation("FromPage")
  linkedFrom PageLink[]    @relation("ToPage")
  history    PageHistory[]
  comments   PageComment[]

  // التدقيق (Audit Trail)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String
  updatedBy String?

  @@index([slug])
  @@index([type])
  @@index([category])
  @@index([status])
  @@index([isPublished])
  @@index([isFavorite])
  @@index([parentId])
  @@index([createdAt])
  @@map("documentation_pages")
}

/// أنواع الصفحات
enum PageType {
  GUIDE /// دليل
  DOCUMENTATION /// توثيق تقني
  TASK /// مهمة
  REPORT /// تقرير
  IDEA /// فكرة
  CHAT /// محادثة
  NOTE /// ملاحظة
  REFERENCE /// مرجع
}

/// حالات الصفحة
enum PageStatus {
  DRAFT /// مسودة
  REVIEW /// قيد المراجعة
  PUBLISHED /// منشورة
  ARCHIVED /// مؤرشفة
}

// ============================================================================
// IDEAS BANK (بنك الأفكار)
// ============================================================================

/// الأفكار - بنك الأفكار في نظام الدفتر الذكي
model Idea {
  id          String       @id @default(cuid())
  title       String /// عنوان الفكرة
  description String       @db.Text /// وصف تفصيلي
  category    IdeaCategory /// الفئة
  priority    Priority     @default(MEDIUM) /// الأولوية
  rating      Int          @default(0) /// التقييم (1-5)
  status      IdeaStatus   @default(NEW) /// الحالة

  // البيانات الإضافية
  estimatedEffort String? /// الجهد المتوقع
  expectedValue   String? /// القيمة المتوقعة
  notes           String?  @db.Text /// ملاحظات إضافية
  tags            String[] /// وسوم
  relatedSystem   String? /// النظام المرتبط (maps, accounting, etc.)

  // العلاقات

  tasks Task[] /// المهام المحولة من هذه الفكرة

  // الأفكار المرتبطة (Many-to-Many Self-Relation)

  // الربط بصفحة التوثيق
  pageId String?
  page   DocumentationPage? @relation(fields: [pageId], references: [id], onDelete: SetNull)

  // التواريخ
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  reviewedAt  DateTime? /// تاريخ المراجعة
  convertedAt DateTime? /// تاريخ التحويل لمهمة

  // التدقيق
  createdBy  String
  updatedBy  String?
  reviewedBy String? /// من راجع الفكرة

  @@index([status])
  @@index([category])
  @@index([priority])
  @@index([rating])
  @@index([relatedSystem])
  @@index([createdAt])
  @@map("ideas")
}

/// حالات الفكرة
enum IdeaStatus {
  NEW /// جديدة
  UNDER_REVIEW /// قيد المراجعة
  APPROVED /// معتمدة
  CONVERTED /// محولة لمهمة
  REJECTED /// مرفوضة
  ON_HOLD /// معلقة
}

/// تصنيفات الأفكار
enum IdeaCategory {
  INFRASTRUCTURE /// بنية تحتية
  FEATURE /// ميزة جديدة
  IMPROVEMENT /// تحسين
  BUG_FIX /// إصلاح
  DOCUMENTATION /// توثيق
  OPTIMIZATION /// تحسين أداء
  SECURITY /// أمان
  UI_UX /// واجهة المستخدم
  DATABASE /// قاعدة بيانات
  API /// واجهة برمجية
  OTHER /// أخرى
}

// ============================================================================
// CHAT LOGS (سجل المحادثات)
// ============================================================================

/// سجل المحادثات مع Manus
model ChatLog {
  id      String  @id @default(cuid())
  title   String /// عنوان المحادثة
  summary String? /// ملخص المحادثة
  content String  @db.Text /// المحادثة الكاملة (JSON أو Text)

  // الإحصائيات
  messageCount Int @default(0) /// عدد الرسائل

  // التصنيف
  topic      ChatTopic /// موضوع المحادثة
  tags       String[] /// وسوم
  isFavorite Boolean   @default(false) /// مميزة بنجمة؟

  // الربط
  pageId String?
  page   DocumentationPage? @relation(fields: [pageId], references: [id], onDelete: SetNull)

  // المهام المرتبطة
  relatedTasks Task[]

  // الملاحظات
  notes String? @db.Text /// ملاحظات على المحادثة

  // التدقيق (Audit Trail)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String

  @@index([topic])
  @@index([isFavorite])
  @@index([createdAt])
  @@map("chat_logs")
}

/// مواضيع المحادثات
enum ChatTopic {
  DEVELOPMENT /// تطوير
  BUG_FIX /// إصلاح أخطاء
  PLANNING /// تخطيط
  DISCUSSION /// نقاش
  SUPPORT /// دعم
  RESEARCH /// بحث
  REVIEW /// مراجعة
  OTHER /// أخرى
}

// ============================================================================
// REPORTS LIBRARY (مكتبة التقارير)
// ============================================================================

/// التقارير - مكتبة لحفظ وتنظيم التقارير
model Report {
  id      String  @id @default(cuid())
  title   String /// عنوان التقرير
  content String  @db.Text /// محتوى التقرير (Markdown)
  summary String? /// ملخص التقرير

  // التصنيف
  type     ReportType /// نوع التقرير
  category String /// التصنيف
  tags     String[] /// وسوم
  status   ReportStatus @default(DRAFT) /// حالة التقرير
  format   ReportFormat @default(MARKDOWN) /// صيغة التقرير

  // المصدر
  sourceRepo String? /// المستودع المصدر
  sourceFile String? /// اسم الملف الأصلي
  sourcePath String? /// المسار الكامل
  importedAt DateTime? /// تاريخ الاستيراد

  // البيانات الوصفية
  fileSize Int? /// حجم الملف (بايت)
  version  String? /// رقم الإصدار

  // الربط
  pageId String?
  page   DocumentationPage? @relation(fields: [pageId], references: [id], onDelete: SetNull)

  // التدقيق (Audit Trail)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String
  updatedBy String?

  @@index([type])
  @@index([category])
  @@index([sourceRepo])
  @@index([importedAt])
  @@index([createdAt])
  @@map("reports")
}

/// أنواع التقارير
enum ReportType {
  ACHIEVEMENT /// إنجاز
  PHASE /// مرحلة
  UPDATE /// تحديث
  ANALYSIS /// تحليل
  SUMMARY /// ملخص
  TECHNICAL /// تقني
  BUSINESS /// عمل
  DOCUMENTATION /// توثيق
  USER_GUIDE /// دليل المستخدم
  DEVELOPER_GUIDE /// دليل المطور
  ARCHITECTURE /// بنية معمارية
  SYSTEM_GUIDE /// دليل نظام
  COMPREHENSIVE /// شامل
  OTHER /// أخرى
}

/// حالة التقرير
enum ReportStatus {
  DRAFT /// مسودة
  PUBLISHED /// منشور
  ARCHIVED /// مؤرشف
}

/// صيغة التقرير
enum ReportFormat {
  MARKDOWN /// Markdown
  PDF /// PDF
  HTML /// HTML
  JSON /// JSON
  TEXT /// نص عادي
}

// ============================================================================
// TASKS MANAGEMENT (إدارة المهام)
// ============================================================================

/// المهام - نظام إدارة المهام في الدفتر الذكي
model Task {
  id          String     @id @default(cuid())
  title       String /// عنوان المهمة
  description String     @db.Text /// وصف تفصيلي
  status      TaskStatus @default(NEW) /// الحالة
  priority    Priority   @default(MEDIUM) /// الأولوية
  progress    Int        @default(0) /// نسبة الإنجاز (0-100)

  // المسؤولية
  assignee      String? /// المسؤول
  assigneeEmail String? /// بريد المسؤول
  team          String? /// الفريق المسؤول

  // التقدير
  estimatedHours Int? /// الساعات المتوقعة
  actualHours    Int? /// الساعات الفعلية

  // العلاقات
  ideaId String? /// الفكرة المصدر
  idea   Idea?   @relation(fields: [ideaId], references: [id], onDelete: SetNull)


  // الربط بالصفحة
  pageId String?
  page   DocumentationPage? @relation(fields: [pageId], references: [id], onDelete: SetNull)

  // الربط بالمحادثات
  chatLogId String?
  chatLog   ChatLog? @relation(fields: [chatLogId], references: [id], onDelete: SetNull)

  // المهام الفرعية
  parentTaskId String?
  parentTask   Task?   @relation("TaskHierarchy", fields: [parentTaskId], references: [id], onDelete: Cascade)
  subTasks     Task[]  @relation("TaskHierarchy")

  // التواريخ
  startDate     DateTime? /// تاريخ البدء
  dueDate       DateTime? /// الموعد النهائي
  completedDate DateTime? /// تاريخ الإنجاز الفعلي

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // ملاحظات
  notes    String?  @db.Text /// ملاحظات التنفيذ
  blockers String?  @db.Text /// المعوقات
  tags     String[] /// وسوم

  // التدقيق
  createdBy String
  updatedBy String?

  @@index([status])
  @@index([priority])
  @@index([assignee])
  @@index([dueDate])
  @@index([ideaId])
  @@index([pageId])
  @@index([chatLogId])
  @@index([parentTaskId])
  @@index([createdAt])
  @@map("tasks")
}

/// حالات المهمة
enum TaskStatus {
  NEW /// جديدة
  IN_PROGRESS /// قيد التنفيذ
  COMPLETED /// مكتملة
  ON_HOLD /// معلقة
  CANCELLED /// ملغاة
  BLOCKED /// محظورة
  REVIEW /// قيد المراجعة
}

/// مصادر المهام
enum TaskSource {
  MANUAL /// يدوية
  IDEA /// من فكرة
  CHAT /// من محادثة
  REPORT /// من تقرير
  PAGE /// من صفحة
}

/// الأولويات
enum Priority {
  LOW /// منخفضة
  MEDIUM /// متوسطة
  HIGH /// عالية
  URGENT /// عاجلة
}

// ============================================================================
// SUPPORTING MODELS (نماذج داعمة)
// ============================================================================

/// روابط بين الصفحات
model PageLink {
  id String @id @default(cuid())

  fromPageId String
  fromPage   DocumentationPage @relation("FromPage", fields: [fromPageId], references: [id], onDelete: Cascade)

  toPageId String
  toPage   DocumentationPage @relation("ToPage", fields: [toPageId], references: [id], onDelete: Cascade)

  linkType String? /// نوع الرابط (related, reference, etc.)

  createdAt DateTime @default(now())
  createdBy String

  @@unique([fromPageId, toPageId])
  @@index([fromPageId])
  @@index([toPageId])
  @@map("page_links")
}

/// تاريخ التعديلات على الصفحات
model PageHistory {
  id String @id @default(cuid())

  pageId String
  page   DocumentationPage @relation(fields: [pageId], references: [id], onDelete: Cascade)

  content    String  @db.Text /// المحتوى في هذا الإصدار
  version    String /// رقم الإصدار
  changeNote String? /// ملاحظة التغيير

  createdAt DateTime @default(now())
  createdBy String

  @@index([pageId])
  @@index([createdAt])
  @@map("page_history")
}

/// تعليقات على الصفحات
model PageComment {
  id String @id @default(cuid())

  pageId String
  page   DocumentationPage @relation(fields: [pageId], references: [id], onDelete: Cascade)

  content String @db.Text /// محتوى التعليق

  // التعليقات المتداخلة
  parentId String?
  parent   PageComment?  @relation("CommentHierarchy", fields: [parentId], references: [id], onDelete: Cascade)
  replies  PageComment[] @relation("CommentHierarchy")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String
  updatedBy String?

  @@index([pageId])
  @@index([parentId])
  @@index([createdAt])
  @@map("page_comments")
}


// ============================================
// الدفتر السحري (Magic Notebook System)
// ============================================

// Enums
enum MagicIdeaCategory {
  FEATURE
  IMPROVEMENT
  BUG_FIX
  RESEARCH
  OTHER
}

enum MagicIdeaStatus {
  NEW
  IN_PROGRESS
  APPROVED
  REJECTED
  CONVERTED
}

enum MagicPriority {
  HIGH
  MEDIUM
  LOW
}

enum MagicTaskStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum MagicReportType {
  DAILY
  WEEKLY
  MONTHLY
  QUARTERLY
  ANNUAL
  CUSTOM
  PROJECT
  TASK
  IDEA
  COMPLETION
  ANALYSIS
  SUMMARY
}

enum MagicReportStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

// Models
model MagicNotebook {
  id          String   @id @default(cuid())
  title       String
  description String?
  icon        String?  @default("📖")
  color       String?  @default("#4CAF50")
  parentId    String?
  parent      MagicNotebook?  @relation("MagicNotebookHierarchy", fields: [parentId], references: [id], onDelete: Cascade)
  children    MagicNotebook[] @relation("MagicNotebookHierarchy")
  sections    MagicSection[]
  pages       MagicPage[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdBy   String
  userId      String
  user        User @relation(fields: [userId], references: [id], onDelete: Cascade)
  @@index([userId])
  @@index([parentId])
  @@map("magic_notebooks")
}

model MagicSection {
  id          String   @id @default(cuid())
  title       String
  description String?
  order       Int      @default(0)
  notebookId  String
  notebook    MagicNotebook @relation(fields: [notebookId], references: [id], onDelete: Cascade)
  pages       MagicPage[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  userId      String
  user        User @relation(fields: [userId], references: [id], onDelete: Cascade)
  @@index([notebookId])
  @@index([userId])
  @@map("magic_sections")
}

model MagicPage {
  id             String   @id @default(cuid())
  title          String
  content        String   @db.Text
  tags           String[]
  notebookId     String
  notebook       MagicNotebook @relation(fields: [notebookId], references: [id], onDelete: Cascade)
  sectionId      String?
  section        MagicSection? @relation(fields: [sectionId], references: [id], onDelete: SetNull)
  conversationId String?   @unique
  conversation   MagicChatLog?  @relation(fields: [conversationId], references: [id], onDelete: SetNull)
  ideaId         String?   @unique
  idea           MagicIdea?     @relation(fields: [ideaId], references: [id], onDelete: SetNull)
  taskId         String?   @unique
  task           MagicTask?     @relation(fields: [taskId], references: [id], onDelete: SetNull)
  reportId       String?   @unique
  report         MagicReport?   @relation(fields: [reportId], references: [id], onDelete: SetNull)
  stickyNotes    MagicStickyNote[]
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  createdBy      String
  userId         String
  user           User @relation(fields: [userId], references: [id], onDelete: Cascade)
  @@index([notebookId])
  @@index([sectionId])
  @@index([userId])
  @@index([conversationId])
  @@index([ideaId])
  @@index([taskId])
  @@index([reportId])
  @@map("magic_pages")
}

model MagicChatLog {
  id         String   @id @default(cuid())
  title      String
  content    String   @db.Text
  tags       String[]
  isFavorite Boolean  @default(false)
  pageId     String?
  page       MagicPage?
  ideas      MagicIdea[]
  tasks      MagicTask[]
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  createdBy  String
  userId     String
  user       User @relation(fields: [userId], references: [id], onDelete: Cascade)
  @@index([userId])
  @@index([isFavorite])
  @@map("magic_chat_logs")
}

model MagicIdea {
  id             String              @id @default(cuid())
  title          String
  description    String              @db.Text
  category       MagicIdeaCategory   @default(FEATURE)
  priority       MagicPriority       @default(MEDIUM)
  status         MagicIdeaStatus     @default(NEW)
  conversationId String?
  conversation   MagicChatLog? @relation(fields: [conversationId], references: [id], onDelete: SetNull)
  pageId         String?
  page           MagicPage?
  tasks          MagicTask[]
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  createdBy      String
  userId         String
  user           User @relation(fields: [userId], references: [id], onDelete: Cascade)
  @@index([userId])
  @@index([status])
  @@index([category])
  @@index([priority])
  @@index([conversationId])
  @@map("magic_ideas")
}

model MagicTask {
  id          String            @id @default(cuid())
  title       String
  description String            @db.Text
  status      MagicTaskStatus   @default(PENDING)
  priority    MagicPriority     @default(MEDIUM)
  dueDate     DateTime?
  ideaId      String?
  idea        MagicIdea? @relation(fields: [ideaId], references: [id], onDelete: SetNull)
  chatLogId   String?
  chatLog     MagicChatLog? @relation(fields: [chatLogId], references: [id], onDelete: SetNull)
  pageId      String?
  page        MagicPage?
  reports     MagicReport[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  completedAt DateTime?
  createdBy   String
  userId      String
  user        User @relation(fields: [userId], references: [id], onDelete: Cascade)
  @@index([userId])
  @@index([status])
  @@index([priority])
  @@index([ideaId])
  @@index([chatLogId])
  @@map("magic_tasks")
}

model MagicReport {
  id          String              @id @default(cuid())
  title       String
  content     String              @db.Text
  type        MagicReportType     @default(CUSTOM)
  status      MagicReportStatus   @default(DRAFT)
  taskId      String?
  task        MagicTask? @relation(fields: [taskId], references: [id], onDelete: SetNull)
  pageId      String?
  page        MagicPage?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  publishedAt DateTime?
  createdBy   String
  userId      String
  user        User @relation(fields: [userId], references: [id], onDelete: Cascade)
  @@index([userId])
  @@index([status])
  @@index([type])
  @@index([taskId])
  @@map("magic_reports")
}

model MagicArchive {
  id          String   @id @default(cuid())
  entityType  String
  entityId    String
  title       String
  content     String?  @db.Text
  archivePath String
  reason      String?
  archivedAt  DateTime @default(now())
  archivedBy  String
  userId      String
  user        User @relation(fields: [userId], references: [id], onDelete: Cascade)
  @@index([userId])
  @@index([entityType])
  @@index([entityId])
  @@map("magic_archives")
}

model MagicTimelineEvent {
  id          String   @id @default(cuid())
  eventType   String
  entityType  String
  entityId    String
  title       String
  description String?
  metadata    Json?
  occurredAt  DateTime @default(now())
  userId      String
  user        User @relation(fields: [userId], references: [id], onDelete: Cascade)
  @@index([userId])
  @@index([entityType])
  @@index([entityId])
  @@index([occurredAt])
  @@map("magic_timeline_events")
}

model MagicStickyNote {
  id        String   @id @default(cuid())
  content   String   @db.Text
  color     String   @default("#FFEB3B")
  position  Json?
  pageId    String?
  page      MagicPage? @relation(fields: [pageId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  userId    String
  user      User @relation(fields: [userId], references: [id], onDelete: Cascade)
  @@index([userId])
  @@index([pageId])
  @@map("magic_sticky_notes")
}
