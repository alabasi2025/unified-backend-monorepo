// SEMOP - Prisma Schema
// Smart Enterprise Management & Operations Platform
// Version: 0.2.0
// Date: 2025-11-20

generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/.prisma/client"
}

datasource db {
  provider = "postgresql"
}

// ============================================================================
// 1. MULTI-ENTITY SYSTEM (نظام الكيانات المتعددة)
// ============================================================================

/// الشركة القابضة - المستوى الأول في الهيكل الهرمي
model Holding {
  id          String   @id @default(cuid())
  code        String   @unique /// كود فريد للشركة (مثل: HOLD001)
  nameAr      String   /// الاسم بالعربية
  nameEn      String   /// الاسم بالإنجليزية
  description String?  /// وصف الشركة
  logo        String?  /// رابط شعار الشركة
  isActive    Boolean  @default(true) /// هل الشركة نشطة؟
  
  // العلاقات
  units       Unit[]
  users       User[]
  departments Department[]
  workLocations WorkLocation[]
  employees   Employee[]
  payrollPeriods PayrollPeriod[]
  
  // التدقيق (Audit Trail)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdBy   String?
  updatedBy   String?
  
  @@map("holdings")
  @@index([code])
  @@index([isActive])
}

/// الوحدة - المستوى الثاني في الهيكل الهرمي
model Unit {
  id          String   @id @default(cuid())
  code        String   @unique /// كود فريد للوحدة (مثل: UNIT001)
  nameAr      String   /// الاسم بالعربية
  nameEn      String   /// الاسم بالإنجليزية
  description String?  /// وصف الوحدة
  type        UnitType /// نوع الوحدة (فرع، قسم، شعبة، إلخ)
  isActive    Boolean  @default(true) /// هل الوحدة نشطة؟
  
  // العلاقات الهرمية
  holdingId   String
  holding     Holding  @relation(fields: [holdingId], references: [id], onDelete: Cascade)
  
  // العلاقات
  projects    Project[]
  users       User[]
  departments Department[]
  workLocations WorkLocation[]
  employees   Employee[]
  payrollPeriods PayrollPeriod[]
  
  // التدقيق (Audit Trail)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdBy   String?
  updatedBy   String?
  
  @@map("units")
  @@index([code])
  @@index([holdingId])
  @@index([type])
  @@index([isActive])
}

/// أنواع الوحدات
enum UnitType {
  BRANCH        /// فرع
  DEPARTMENT    /// قسم
  DIVISION      /// شعبة
  SUBSIDIARY    /// شركة تابعة
  OTHER         /// أخرى
}

/// المشروع - المستوى الثالث في الهيكل الهرمي
model Project {
  id          String        @id @default(cuid())
  code        String        @unique /// كود فريد للمشروع (مثل: PROJ001)
  nameAr      String        /// الاسم بالعربية
  nameEn      String        /// الاسم بالإنجليزية
  description String?       /// وصف المشروع
  status      ProjectStatus /// حالة المشروع
  startDate   DateTime?     /// تاريخ البدء
  endDate     DateTime?     /// تاريخ الانتهاء المتوقع
  budget      Decimal?      @db.Decimal(15, 2) /// الميزانية
  isActive    Boolean       @default(true) /// هل المشروع نشط؟
  
  // العلاقات الهرمية
  unitId      String
  unit        Unit          @relation(fields: [unitId], references: [id], onDelete: Cascade)
  
  // العلاقات
  users       User[]
  departments Department[]
  employees   Employee[]
  
  // التدقيق (Audit Trail)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  createdBy   String?
  updatedBy   String?
  
  @@map("projects")
  @@index([code])
  @@index([unitId])
  @@index([status])
  @@index([isActive])
}

/// حالات المشروع
enum ProjectStatus {
  PLANNING      /// تخطيط
  IN_PROGRESS   /// قيد التنفيذ
  ON_HOLD       /// معلق
  COMPLETED     /// مكتمل
  CANCELLED     /// ملغي
}

// ============================================================================
// 2. IDENTITY & ACCESS MANAGEMENT (نظام الهوية والصلاحيات)
// ============================================================================

/// المستخدم
model User {
  id              String    @id @default(cuid())
  username        String    @unique /// اسم المستخدم
  email           String    @unique /// البريد الإلكتروني
  passwordHash    String    /// كلمة المرور المشفرة (bcrypt)
  firstName       String    /// الاسم الأول
  lastName        String    /// الاسم الأخير
  phone           String?   /// رقم الهاتف
  avatar          String?   /// رابط صورة المستخدم
  isActive        Boolean   @default(true) /// هل المستخدم نشط؟
  isEmailVerified Boolean   @default(false) /// هل البريد مُفعّل؟
  lastLoginAt     DateTime? /// آخر تسجيل دخول
  
  // العلاقات مع الكيانات (Multi-Entity Support)
  // المستخدم يمكن أن ينتمي لـ Holding أو Unit أو Project
  holdingId       String?
  holding         Holding?  @relation(fields: [holdingId], references: [id], onDelete: SetNull)
  
  unitId          String?
  unit            Unit?     @relation(fields: [unitId], references: [id], onDelete: SetNull)
  
  projectId       String?
  project         Project?  @relation(fields: [projectId], references: [id], onDelete: SetNull)
  
  // العلاقات مع الأدوار
  userRoles       UserRole[]
  
  // التدقيق (Audit Trail)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  createdBy       String?
  updatedBy       String?
  
  @@map("users")
  @@index([email])
  @@index([username])
  @@index([holdingId])
  @@index([unitId])
  @@index([projectId])
  @@index([isActive])
}

/// الدور (Role)
model Role {
  id          String   @id @default(cuid())
  code        String   @unique /// كود الدور (مثل: SUPER_ADMIN)
  nameAr      String   /// الاسم بالعربية
  nameEn      String   /// الاسم بالإنجليزية
  description String?  /// وصف الدور
  isSystem    Boolean  @default(false) /// هل هو دور نظام (لا يمكن حذفه)
  isActive    Boolean  @default(true) /// هل الدور نشط؟
  
  // العلاقات
  userRoles       UserRole[]
  rolePermissions RolePermission[]
  
  // التدقيق (Audit Trail)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@map("roles")
  @@index([code])
  @@index([isSystem])
  @@index([isActive])
}

/// الصلاحية (Permission)
model Permission {
  id          String   @id @default(cuid())
  code        String   @unique /// كود الصلاحية (مثل: USER_CREATE)
  nameAr      String   /// الاسم بالعربية
  nameEn      String   /// الاسم بالإنجليزية
  description String?  /// وصف الصلاحية
  module      String   /// اسم الوحدة (مثل: users, inventory)
  action      String   /// الإجراء (create, read, update, delete)
  
  // العلاقات
  rolePermissions RolePermission[]
  
  // التدقيق (Audit Trail)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@map("permissions")
  @@unique([module, action])
  @@index([code])
  @@index([module])
}

/// ربط المستخدم بالدور (Many-to-Many)
model UserRole {
  id        String   @id @default(cuid())
  
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  roleId    String
  role      Role     @relation(fields: [roleId], references: [id], onDelete: Cascade)
  
  // التدقيق (Audit Trail)
  assignedAt DateTime @default(now())
  assignedBy String?
  
  @@map("user_roles")
  @@unique([userId, roleId])
  @@index([userId])
  @@index([roleId])
}

/// ربط الدور بالصلاحية (Many-to-Many)
model RolePermission {
  id           String     @id @default(cuid())
  
  roleId       String
  role         Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  
  permissionId String
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  
  // التدقيق (Audit Trail)
  assignedAt   DateTime   @default(now())
  assignedBy   String?
  
  @@map("role_permissions")
  @@unique([roleId, permissionId])
  @@index([roleId])
  @@index([permissionId])
}

// ============================================================================
// 3. CONFIGURATION SYSTEM (نظام التكوين)
// ============================================================================

/// التكوين (Configuration)
model Configuration {
  id          String          @id @default(cuid())
  key         String          /// مفتاح التكوين (مثل: currency, timezone)
  value       String          /// القيمة (JSON string)
  dataType    ConfigDataType  /// نوع البيانات
  scope       ConfigScope     /// نطاق التكوين
  
  // العلاقات مع الكيانات (اختياري حسب scope)
  holdingId   String?
  unitId      String?
  projectId   String?
  
  // الوصف
  nameAr      String
  nameEn      String
  description String?
  
  // التدقيق (Audit Trail)
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  createdBy   String?
  updatedBy   String?
  
  @@map("configurations")
  @@unique([key, scope, holdingId, unitId, projectId])
  @@index([key])
  @@index([scope])
}

/// أنواع بيانات التكوين
enum ConfigDataType {
  STRING
  NUMBER
  BOOLEAN
  JSON
  DATE
}

/// نطاق التكوين
enum ConfigScope {
  SYSTEM      /// على مستوى النظام
  HOLDING     /// على مستوى الشركة القابضة
  UNIT        /// على مستوى الوحدة
  PROJECT     /// على مستوى المشروع
}

// ============================================================================
// 4. ACCOUNTING SYSTEM - CHART OF ACCOUNTS (نظام دليل الحسابات)
// ============================================================================

/// الحساب المحاسبي
model Account {
  id               String        @id @default(cuid())
  code             String        @unique /// رمز الحساب (مثل: 1010, 2010)
  nameAr           String        /// الاسم بالعربية
  nameEn           String        /// الاسم بالإنجليزية
  description      String?       /// وصف الحساب
  accountType      AccountType   /// نوع الحساب (أصول، خصوم، إلخ)
  accountNature    AccountNature /// طبيعة الحساب (مدين، دائن)
  level            Int           /// مستوى الحساب في الشجرة (1, 2, 3, ...)
  isParent         Boolean       @default(false) /// هل الحساب رئيسي (يحتوي على حسابات فرعية)
  isActive         Boolean       @default(true) /// حالة التفعيل
  allowManualEntry Boolean       @default(true) /// السماح بالقيد المباشر (false للحسابات الرئيسية)
  
  // العلاقات الهرمية (Self-Referencing)
  parentId         String?
  parent           Account?      @relation("AccountHierarchy", fields: [parentId], references: [id], onDelete: SetNull)
  children         Account[]     @relation("AccountHierarchy")
  
  // العلاقات مع الكيانات (اختياري)
  holdingId        String?
  unitId           String?
  
  // العلاقات
  journalEntryLines JournalEntryLine[]
  accountBalances   AccountBalance[]
  hierarchyAsAccount AccountHierarchy[] @relation("AccountAsAccount")
  hierarchyAsAncestor AccountHierarchy[] @relation("AccountAsAncestor")
  
  // Item Relations (Inventory Integration)
  itemsAsSalesAccount     Item[] @relation("ItemSalesAccount")
  itemsAsPurchaseAccount  Item[] @relation("ItemPurchaseAccount")
  itemsAsInventoryAccount Item[] @relation("ItemInventoryAccount")
  
  // HR Relations
  allowanceTypes AllowanceType[]
  deductionTypes DeductionType[]
  bonusTypes     BonusType[]
  
  // التدقيق (Audit Trail)
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
  createdBy        String?
  updatedBy        String?
  
  @@map("accounts")
  @@index([code])
  @@index([accountType])
  @@index([parentId])
  @@index([holdingId])
  @@index([unitId])
  @@index([isActive])
  @@index([allowManualEntry])
}

/// نوع الحساب
enum AccountType {
  ASSET       /// أصول
  LIABILITY   /// خصوم (التزامات)
  EQUITY      /// حقوق ملكية
  REVENUE     /// إيرادات
  EXPENSE     /// مصروفات
}

/// طبيعة الحساب
enum AccountNature {
  DEBIT       /// مدين (الأصول والمصروفات)
  CREDIT      /// دائن (الخصوم وحقوق الملكية والإيرادات)
}

/// أرصدة الحسابات
model AccountBalance {
  id             String   @id @default(cuid())
  
  accountId      String
  account        Account  @relation(fields: [accountId], references: [id], onDelete: Cascade)
  
  fiscalYearId   String
  fiscalYear     FiscalYear @relation(fields: [fiscalYearId], references: [id], onDelete: Cascade)
  
  openingBalance Decimal  @default(0) @db.Decimal(15, 2) /// الرصيد الافتتاحي
  closingBalance Decimal  @default(0) @db.Decimal(15, 2) /// الرصيد الختامي
  debitTotal     Decimal  @default(0) @db.Decimal(15, 2) /// إجمالي المدين
  creditTotal    Decimal  @default(0) @db.Decimal(15, 2) /// إجمالي الدائن
  
  // التدقيق (Audit Trail)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  
  @@map("account_balances")
  @@unique([accountId, fiscalYearId])
  @@index([accountId])
  @@index([fiscalYearId])
}

/// التسلسل الهرمي للحسابات (Materialized Path)
model AccountHierarchy {
  id         String  @id @default(cuid())
  
  accountId  String
  account    Account @relation("AccountAsAccount", fields: [accountId], references: [id], onDelete: Cascade)
  
  ancestorId String
  ancestor   Account @relation("AccountAsAncestor", fields: [ancestorId], references: [id], onDelete: Cascade)
  
  depth      Int     /// عمق العلاقة (0 للحساب نفسه، 1 للأب المباشر، إلخ)
  
  @@map("account_hierarchy")
  @@index([accountId, ancestorId])
  @@index([accountId])
  @@index([ancestorId])
}

// ============================================================================
// 5. ACCOUNTING SYSTEM - JOURNAL ENTRIES (نظام القيود اليومية)
// ============================================================================

/// القيد المحاسبي (رأس القيد)
model JournalEntry {
  id           String             @id @default(cuid())
  entryNumber  String             @unique /// رقم القيد (مثل: JE-2025-0001)
  entryDate    DateTime           /// تاريخ القيد
  description  String             /// وصف القيد
  reference    String?            /// مرجع خارجي (رقم فاتورة، شيك، إلخ)
  entryType    JournalEntryType   /// نوع القيد
  status       JournalEntryStatus @default(DRAFT) /// حالة القيد
  totalDebit   Decimal            @default(0) @db.Decimal(15, 2) /// إجمالي المدين
  totalCredit  Decimal            @default(0) @db.Decimal(15, 2) /// إجمالي الدائن
  isBalanced   Boolean            @default(false) /// هل القيد متوازن (Computed)
  
  // الترحيل والعكس
  postedAt     DateTime?          /// تاريخ الترحيل
  postedBy     String?            /// من قام بالترحيل
  reversedAt   DateTime?          /// تاريخ العكس
  reversedBy   String?            /// من قام بالعكس
  
  // العلاقة مع القيد المعكوس
  reversalOfId String?
  reversalOf   JournalEntry?      @relation("ReversalRelation", fields: [reversalOfId], references: [id], onDelete: SetNull)
  reversals    JournalEntry[]     @relation("ReversalRelation")
  
  // العلاقات مع الكيانات
  fiscalYearId String
  fiscalYear   FiscalYear         @relation(fields: [fiscalYearId], references: [id], onDelete: Restrict)
  
  holdingId    String?
  unitId       String?
  projectId    String?
  
  // العلاقات
  lines        JournalEntryLine[]
  
  // Invoice Relations
  purchaseInvoices PurchaseInvoice[]
  purchaseReturns  PurchaseReturn[]
  salesInvoices    SalesInvoice[]
  salesReturns     SalesReturn[]
  
  // Payroll Relations
  payrollPeriods   PayrollPeriod[]
  
  // التدقيق (Audit Trail)
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt
  createdBy    String?
  updatedBy    String?
  
  @@map("journal_entries")
  @@index([entryNumber])
  @@index([entryDate])
  @@index([status])
  @@index([fiscalYearId])
  @@index([holdingId])
  @@index([unitId])
  @@index([projectId])
}

/// نوع القيد
enum JournalEntryType {
  OPENING     /// قيد افتتاحي
  REGULAR     /// قيد عادي
  CLOSING     /// قيد إقفال
  ADJUSTMENT  /// قيد تسوية
}

/// حالة القيد
enum JournalEntryStatus {
  DRAFT       /// مسودة (قابل للتعديل)
  POSTED      /// مرحّل (غير قابل للتعديل)
  REVERSED    /// معكوس
}

/// سطر القيد المحاسبي
model JournalEntryLine {
  id             String        @id @default(cuid())
  
  journalEntryId String
  journalEntry   JournalEntry  @relation(fields: [journalEntryId], references: [id], onDelete: Cascade)
  
  lineNumber     Int           /// رقم السطر (1, 2, 3, ...)
  
  accountId      String
  account        Account       @relation(fields: [accountId], references: [id], onDelete: Restrict)
  
  description    String        /// وصف السطر
  debit          Decimal       @default(0) @db.Decimal(15, 2) /// المبلغ المدين
  credit         Decimal       @default(0) @db.Decimal(15, 2) /// المبلغ الدائن
  
  // مركز التكلفة (اختياري)
  costCenterId   String?
  costCenter     CostCenter?   @relation(fields: [costCenterId], references: [id], onDelete: SetNull)
  
  // التدقيق (Audit Trail)
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  
  @@map("journal_entry_lines")
  @@unique([journalEntryId, lineNumber])
  @@index([journalEntryId])
  @@index([accountId])
  @@index([costCenterId])
}

// ============================================================================
// 6. ACCOUNTING SYSTEM - COST CENTERS (نظام مراكز التكلفة)
// ============================================================================

/// مركز التكلفة
model CostCenter {
  id          String   @id @default(cuid())
  code        String   @unique /// رمز مركز التكلفة
  nameAr      String   /// الاسم بالعربية
  nameEn      String   /// الاسم بالإنجليزية
  description String?  /// الوصف
  isActive    Boolean  @default(true) /// حالة التفعيل
  
  // العلاقات الهرمية (Self-Referencing)
  parentId    String?
  parent      CostCenter? @relation("CostCenterHierarchy", fields: [parentId], references: [id], onDelete: SetNull)
  children    CostCenter[] @relation("CostCenterHierarchy")
  
  // العلاقات مع الكيانات (اختياري)
  holdingId   String?
  unitId      String?
  projectId   String?
  
  // العلاقات
  journalEntryLines JournalEntryLine[]
  departments       Department[]
  
  // التدقيق (Audit Trail)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdBy   String?
  updatedBy   String?
  
  @@map("cost_centers")
  @@index([code])
  @@index([parentId])
  @@index([holdingId])
  @@index([unitId])
  @@index([projectId])
  @@index([isActive])
}

// ============================================================================
// 7. ACCOUNTING SYSTEM - FISCAL YEARS (نظام السنوات المالية)
// ============================================================================

/// السنة المالية
model FiscalYear {
  id          String           @id @default(cuid())
  code        String           @unique /// رمز السنة المالية (مثل: FY-2025)
  nameAr      String           /// الاسم بالعربية
  nameEn      String           /// الاسم بالإنجليزية
  startDate   DateTime         /// تاريخ بداية السنة المالية
  endDate     DateTime         /// تاريخ نهاية السنة المالية
  status      FiscalYearStatus @default(OPEN) /// حالة السنة
  isCurrent   Boolean          @default(false) /// هل هي السنة الحالية
  
  // العلاقات مع الكيانات (اختياري)
  holdingId   String?
  
  // العلاقات
  periods         FiscalPeriod[]
  journalEntries  JournalEntry[]
  accountBalances AccountBalance[]
  
  // التدقيق (Audit Trail)
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  createdBy   String?
  updatedBy   String?
  
  @@map("fiscal_years")
  @@index([code])
  @@index([startDate])
  @@index([endDate])
  @@index([status])
  @@index([isCurrent])
  @@index([holdingId])
}

/// حالة السنة المالية
enum FiscalYearStatus {
  OPEN    /// مفتوحة (قابلة للقيد)
  CLOSED  /// مغلقة (غير قابلة للقيد)
  LOCKED  /// مقفلة (مغلقة نهائياً)
}

/// الفترة المحاسبية
model FiscalPeriod {
  id           String             @id @default(cuid())
  
  fiscalYearId String
  fiscalYear   FiscalYear         @relation(fields: [fiscalYearId], references: [id], onDelete: Cascade)
  
  periodNumber Int                /// رقم الفترة (1-12 للشهور)
  nameAr       String             /// الاسم بالعربية (يناير، فبراير، ...)
  nameEn       String             /// الاسم بالإنجليزية (January, February, ...)
  startDate    DateTime           /// تاريخ بداية الفترة
  endDate      DateTime           /// تاريخ نهاية الفترة
  status       FiscalPeriodStatus @default(OPEN) /// حالة الفترة
  
  // التدقيق (Audit Trail)
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt
  
  @@map("fiscal_periods")
  @@unique([fiscalYearId, periodNumber])
  @@index([fiscalYearId])
  @@index([status])
  @@index([startDate])
  @@index([endDate])
}

/// حالة الفترة المحاسبية
enum FiscalPeriodStatus {
  OPEN    /// مفتوحة
  CLOSED  /// مغلقة
}


// ============================================================================
// 6. SUPPLIERS SYSTEM (نظام الموردين)
// ============================================================================

/// فئات الموردين
model SupplierCategory {
  id          String   @id @default(cuid())
  code        String   @unique
  nameAr      String
  nameEn      String
  description String?
  isActive    Boolean  @default(true)
  
  // Relations
  suppliers   Supplier[]
  
  // Audit Trail
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdBy   String?
  updatedBy   String?
  
  @@map("supplier_categories")
  @@index([code])
  @@index([isActive])
}

/// الموردين
model Supplier {
  id                  String   @id @default(cuid())
  code                String   @unique
  nameAr              String
  nameEn              String
  taxNumber           String?  @unique
  commercialRegister  String?
  email               String?
  phone               String?
  website             String?
  paymentTerms        Int      @default(30) /// أيام الدفع
  creditLimit         Decimal  @default(0) @db.Decimal(15, 2)
  currentBalance      Decimal  @default(0) @db.Decimal(15, 2)
  isActive            Boolean  @default(true)
  
  // Relations
  categoryId          String?
  category            SupplierCategory? @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  
  // Multi-Entity Support
  holdingId           String?
  unitId              String?
  
  // Relations
  addresses           SupplierAddress[]
  contacts            SupplierContact[]
  purchaseOrders      PurchaseOrder[]
  purchaseInvoices    PurchaseInvoice[]
  purchaseReturns     PurchaseReturn[]
  
  // Audit Trail
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  createdBy           String?
  updatedBy           String?
  
  @@map("suppliers")
  @@index([code])
  @@index([taxNumber])
  @@index([email])
  @@index([categoryId])
  @@index([holdingId])
  @@index([unitId])
  @@index([isActive])
}

enum AddressType {
  BILLING
  SHIPPING
  BOTH
}

/// عناوين الموردين
model SupplierAddress {
  id              String      @id @default(cuid())
  supplierId      String
  supplier        Supplier    @relation(fields: [supplierId], references: [id], onDelete: Cascade)
  
  addressType     AddressType
  country         String
  city            String
  district        String?
  street          String?
  buildingNumber  String?
  postalCode      String?
  isPrimary       Boolean     @default(false)
  
  // Audit Trail
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  
  @@map("supplier_addresses")
  @@index([supplierId])
  @@index([addressType])
  @@index([isPrimary])
}

/// جهات اتصال الموردين
model SupplierContact {
  id          String   @id @default(cuid())
  supplierId  String
  supplier    Supplier @relation(fields: [supplierId], references: [id], onDelete: Cascade)
  
  name        String
  position    String?
  email       String?
  phone       String?
  mobile      String?
  isPrimary   Boolean  @default(false)
  
  // Audit Trail
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@map("supplier_contacts")
  @@index([supplierId])
  @@index([isPrimary])
}

// ============================================================================
// 7. CUSTOMERS SYSTEM (نظام العملاء)
// ============================================================================

/// فئات العملاء
model CustomerCategory {
  id                  String   @id @default(cuid())
  code                String   @unique
  nameAr              String
  nameEn              String
  description         String?
  discountPercentage  Decimal  @default(0) @db.Decimal(5, 2)
  isActive            Boolean  @default(true)
  
  // Relations
  customers           Customer[]
  
  // Audit Trail
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  createdBy           String?
  updatedBy           String?
  
  @@map("customer_categories")
  @@index([code])
  @@index([isActive])
}

/// العملاء
model Customer {
  id                  String   @id @default(cuid())
  code                String   @unique
  nameAr              String
  nameEn              String
  taxNumber           String?  @unique
  commercialRegister  String?
  email               String?
  phone               String?
  website             String?
  paymentTerms        Int      @default(30)
  creditLimit         Decimal  @default(0) @db.Decimal(15, 2)
  currentBalance      Decimal  @default(0) @db.Decimal(15, 2)
  isActive            Boolean  @default(true)
  
  // Relations
  categoryId          String?
  category            CustomerCategory? @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  
  // Multi-Entity Support
  holdingId           String?
  unitId              String?
  
  // Relations
  addresses           CustomerAddress[]
  contacts            CustomerContact[]
  salesOrders         SalesOrder[]
  salesInvoices       SalesInvoice[]
  salesReturns        SalesReturn[]
  
  // Audit Trail
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  createdBy           String?
  updatedBy           String?
  
  @@map("customers")
  @@index([code])
  @@index([taxNumber])
  @@index([email])
  @@index([categoryId])
  @@index([holdingId])
  @@index([unitId])
  @@index([isActive])
}

/// عناوين العملاء
model CustomerAddress {
  id              String      @id @default(cuid())
  customerId      String
  customer        Customer    @relation(fields: [customerId], references: [id], onDelete: Cascade)
  
  addressType     AddressType
  country         String
  city            String
  district        String?
  street          String?
  buildingNumber  String?
  postalCode      String?
  isPrimary       Boolean     @default(false)
  
  // Audit Trail
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  
  @@map("customer_addresses")
  @@index([customerId])
  @@index([addressType])
  @@index([isPrimary])
}

/// جهات اتصال العملاء
model CustomerContact {
  id          String   @id @default(cuid())
  customerId  String
  customer    Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  
  name        String
  position    String?
  email       String?
  phone       String?
  mobile      String?
  isPrimary   Boolean  @default(false)
  
  // Audit Trail
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@map("customer_contacts")
  @@index([customerId])
  @@index([isPrimary])
}

// ============================================================================
// 8. INVENTORY SYSTEM (نظام المخزون)
// ============================================================================

/// فئات الأصناف
model ItemCategory {
  id          String   @id @default(cuid())
  code        String   @unique
  nameAr      String
  nameEn      String
  description String?
  isActive    Boolean  @default(true)
  
  // Self-Referencing (Hierarchical)
  parentId    String?
  parent      ItemCategory?  @relation("ItemCategoryHierarchy", fields: [parentId], references: [id], onDelete: SetNull)
  children    ItemCategory[] @relation("ItemCategoryHierarchy")
  
  // Relations
  items       Item[]
  
  // Audit Trail
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdBy   String?
  updatedBy   String?
  
  @@map("item_categories")
  @@index([code])
  @@index([parentId])
  @@index([isActive])
}

enum ItemType {
  PRODUCT   /// منتج
  SERVICE   /// خدمة
  MATERIAL  /// مادة خام
}

/// الأصناف
model Item {
  id                  String   @id @default(cuid())
  code                String   @unique
  barcode             String?  @unique
  nameAr              String
  nameEn              String
  description         String?
  itemType            ItemType
  unit                String   /// وحدة القياس
  
  // Pricing
  costPrice           Decimal  @default(0) @db.Decimal(15, 2)
  sellingPrice        Decimal  @default(0) @db.Decimal(15, 2)
  minSellingPrice     Decimal? @db.Decimal(15, 2)
  
  // Stock
  reorderLevel        Decimal? @db.Decimal(10, 2)
  maxStockLevel       Decimal? @db.Decimal(10, 2)
  
  // Flags
  isActive            Boolean  @default(true)
  isSellable          Boolean  @default(true)
  isPurchasable       Boolean  @default(true)
  isStockable         Boolean  @default(true)
  
  // Relations
  categoryId          String?
  category            ItemCategory? @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  
  // Accounting Integration
  salesAccountId      String?
  salesAccount        Account?  @relation("ItemSalesAccount", fields: [salesAccountId], references: [id], onDelete: SetNull)
  
  purchaseAccountId   String?
  purchaseAccount     Account?  @relation("ItemPurchaseAccount", fields: [purchaseAccountId], references: [id], onDelete: SetNull)
  
  inventoryAccountId  String?
  inventoryAccount    Account?  @relation("ItemInventoryAccount", fields: [inventoryAccountId], references: [id], onDelete: SetNull)
  
  // Multi-Entity Support
  holdingId           String?
  
  // Relations
  stockLevels         StockLevel[]
  stockMovements      StockMovement[]
  purchaseOrderLines  PurchaseOrderLine[]
  purchaseInvoiceLines PurchaseInvoiceLine[]
  salesOrderLines     SalesOrderLine[]
  salesInvoiceLines   SalesInvoiceLine[]
  stockCountLines     StockCountLine[]
  
  // Audit Trail
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  createdBy           String?
  updatedBy           String?
  
  @@map("items")
  @@index([code])
  @@index([barcode])
  @@index([itemType])
  @@index([categoryId])
  @@index([salesAccountId])
  @@index([purchaseAccountId])
  @@index([inventoryAccountId])
  @@index([holdingId])
  @@index([isActive])
  @@index([isSellable])
  @@index([isPurchasable])
  @@index([isStockable])
}

/// المخازن
model Warehouse {
  id              String   @id @default(cuid())
  code            String   @unique
  nameAr          String
  nameEn          String
  description     String?
  location        String?
  isActive        Boolean  @default(true)
  
  // Multi-Entity Support
  holdingId       String?
  unitId          String?
  
  // Relations
  stockLevels     StockLevel[]
  stockMovements  StockMovement[]
  stockCounts     StockCount[]
  purchaseInvoiceLines PurchaseInvoiceLine[]
  salesInvoiceLines    SalesInvoiceLine[]
  
  // Audit Trail
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  createdBy       String?
  updatedBy       String?
  
  @@map("warehouses")
  @@index([code])
  @@index([holdingId])
  @@index([unitId])
  @@index([isActive])
}

/// مستويات المخزون
model StockLevel {
  id                  String   @id @default(cuid())
  
  itemId              String
  item                Item     @relation(fields: [itemId], references: [id], onDelete: Cascade)
  
  warehouseId         String
  warehouse           Warehouse @relation(fields: [warehouseId], references: [id], onDelete: Cascade)
  
  quantity            Decimal  @default(0) @db.Decimal(10, 2)
  reservedQuantity    Decimal  @default(0) @db.Decimal(10, 2)
  availableQuantity   Decimal  @default(0) @db.Decimal(10, 2)
  
  // Audit Trail
  updatedAt           DateTime @updatedAt
  
  @@map("stock_levels")
  @@unique([itemId, warehouseId])
  @@index([itemId])
  @@index([warehouseId])
}

enum StockMovementType {
  PURCHASE_RECEIPT      /// استلام شراء
  SALES_ISSUE           /// صرف مبيعات
  TRANSFER_IN           /// تحويل وارد
  TRANSFER_OUT          /// تحويل صادر
  ADJUSTMENT_IN         /// تسوية إضافة
  ADJUSTMENT_OUT        /// تسوية خصم
  OPENING_BALANCE       /// رصيد افتتاحي
  RETURN_FROM_CUSTOMER  /// مرتجع من عميل
  RETURN_TO_SUPPLIER    /// مرتجع لمورد
}

/// حركات المخزون
model StockMovement {
  id                      String            @id @default(cuid())
  movementNumber          String            @unique
  movementDate            DateTime
  movementType            StockMovementType
  
  itemId                  String
  item                    Item              @relation(fields: [itemId], references: [id], onDelete: Restrict)
  
  warehouseId             String
  warehouse               Warehouse         @relation(fields: [warehouseId], references: [id], onDelete: Restrict)
  
  quantity                Decimal           @db.Decimal(10, 2)
  unitCost                Decimal?          @db.Decimal(15, 2)
  totalCost               Decimal?          @db.Decimal(15, 2)
  
  reference               String?
  notes                   String?
  
  // Relations (optional based on movement type)
  purchaseInvoiceLineId   String?
  salesInvoiceLineId      String?
  
  // Audit Trail
  createdAt               DateTime          @default(now())
  createdBy               String?
  
  @@map("stock_movements")
  @@index([movementNumber])
  @@index([movementDate])
  @@index([movementType])
  @@index([itemId])
  @@index([warehouseId])
}

enum StockCountStatus {
  DRAFT
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

/// الجرد
model StockCount {
  id              String           @id @default(cuid())
  countNumber     String           @unique
  countDate       DateTime
  status          StockCountStatus
  
  warehouseId     String
  warehouse       Warehouse        @relation(fields: [warehouseId], references: [id], onDelete: Restrict)
  
  notes           String?
  
  // Relations
  lines           StockCountLine[]
  
  // Audit Trail
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  createdBy       String?
  updatedBy       String?
  completedAt     DateTime?
  completedBy     String?
  
  @@map("stock_counts")
  @@index([countNumber])
  @@index([countDate])
  @@index([status])
  @@index([warehouseId])
}

/// سطور الجرد
model StockCountLine {
  id                String     @id @default(cuid())
  
  stockCountId      String
  stockCount        StockCount @relation(fields: [stockCountId], references: [id], onDelete: Cascade)
  
  itemId            String
  item              Item       @relation(fields: [itemId], references: [id], onDelete: Restrict)
  
  systemQuantity    Decimal    @db.Decimal(10, 2)
  countedQuantity   Decimal    @db.Decimal(10, 2)
  difference        Decimal    @db.Decimal(10, 2)
  
  notes             String?
  
  // Audit Trail
  createdAt         DateTime   @default(now())
  updatedAt         DateTime   @updatedAt
  
  @@map("stock_count_lines")
  @@index([stockCountId])
  @@index([itemId])
}

// ============================================================================
// 9. PURCHASES SYSTEM (نظام المشتريات)
// ============================================================================

enum PurchaseOrderStatus {
  DRAFT
  PENDING
  APPROVED
  PARTIALLY_RECEIVED
  RECEIVED
  CANCELLED
}

/// طلبات الشراء
model PurchaseOrder {
  id                    String              @id @default(cuid())
  orderNumber           String              @unique
  orderDate             DateTime
  expectedDeliveryDate  DateTime?
  status                PurchaseOrderStatus
  
  supplierId            String
  supplier              Supplier            @relation(fields: [supplierId], references: [id], onDelete: Restrict)
  
  subtotal              Decimal             @default(0) @db.Decimal(15, 2)
  taxAmount             Decimal             @default(0) @db.Decimal(15, 2)
  discountAmount        Decimal             @default(0) @db.Decimal(15, 2)
  totalAmount           Decimal             @default(0) @db.Decimal(15, 2)
  
  notes                 String?
  
  // Multi-Entity Support
  holdingId             String?
  unitId                String?
  projectId             String?
  
  // Relations
  lines                 PurchaseOrderLine[]
  invoices              PurchaseInvoice[]
  
  // Audit Trail
  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt
  createdBy             String?
  updatedBy             String?
  approvedAt            DateTime?
  approvedBy            String?
  
  @@map("purchase_orders")
  @@index([orderNumber])
  @@index([orderDate])
  @@index([status])
  @@index([supplierId])
  @@index([holdingId])
  @@index([unitId])
  @@index([projectId])
}

/// سطور طلبات الشراء
model PurchaseOrderLine {
  id                String        @id @default(cuid())
  
  purchaseOrderId   String
  purchaseOrder     PurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)
  
  lineNumber        Int
  
  itemId            String
  item              Item          @relation(fields: [itemId], references: [id], onDelete: Restrict)
  
  description       String?
  quantity          Decimal       @db.Decimal(10, 2)
  unitPrice         Decimal       @db.Decimal(15, 2)
  taxRate           Decimal       @default(15) @db.Decimal(5, 2)
  discountRate      Decimal       @default(0) @db.Decimal(5, 2)
  
  // Computed Fields
  lineTotal         Decimal       @db.Decimal(15, 2)
  taxAmount         Decimal       @db.Decimal(15, 2)
  discountAmount    Decimal       @db.Decimal(15, 2)
  netAmount         Decimal       @db.Decimal(15, 2)
  
  receivedQuantity  Decimal       @default(0) @db.Decimal(10, 2)
  
  // Audit Trail
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  
  @@map("purchase_order_lines")
  @@unique([purchaseOrderId, lineNumber])
  @@index([purchaseOrderId])
  @@index([itemId])
}

enum PurchaseInvoiceStatus {
  DRAFT
  POSTED
  PARTIALLY_PAID
  PAID
  CANCELLED
}

/// فواتير الشراء
model PurchaseInvoice {
  id                      String                @id @default(cuid())
  invoiceNumber           String                @unique
  supplierInvoiceNumber   String?
  invoiceDate             DateTime
  dueDate                 DateTime?
  status                  PurchaseInvoiceStatus
  
  supplierId              String
  supplier                Supplier              @relation(fields: [supplierId], references: [id], onDelete: Restrict)
  
  purchaseOrderId         String?
  purchaseOrder           PurchaseOrder?        @relation(fields: [purchaseOrderId], references: [id], onDelete: SetNull)
  
  subtotal                Decimal               @default(0) @db.Decimal(15, 2)
  taxAmount               Decimal               @default(0) @db.Decimal(15, 2)
  discountAmount          Decimal               @default(0) @db.Decimal(15, 2)
  totalAmount             Decimal               @default(0) @db.Decimal(15, 2)
  paidAmount              Decimal               @default(0) @db.Decimal(15, 2)
  remainingAmount         Decimal               @default(0) @db.Decimal(15, 2)
  
  notes                   String?
  
  // Multi-Entity Support
  holdingId               String?
  unitId                  String?
  projectId               String?
  
  // Accounting Integration
  journalEntryId          String?
  journalEntry            JournalEntry?         @relation(fields: [journalEntryId], references: [id], onDelete: SetNull)
  
  // Relations
  lines                   PurchaseInvoiceLine[]
  returns                 PurchaseReturn[]
  
  // Audit Trail
  createdAt               DateTime              @default(now())
  updatedAt               DateTime              @updatedAt
  createdBy               String?
  updatedBy               String?
  postedAt                DateTime?
  postedBy                String?
  
  @@map("purchase_invoices")
  @@index([invoiceNumber])
  @@index([invoiceDate])
  @@index([status])
  @@index([supplierId])
  @@index([purchaseOrderId])
  @@index([journalEntryId])
  @@index([holdingId])
  @@index([unitId])
  @@index([projectId])
}

/// سطور فواتير الشراء
model PurchaseInvoiceLine {
  id                  String          @id @default(cuid())
  
  purchaseInvoiceId   String
  purchaseInvoice     PurchaseInvoice @relation(fields: [purchaseInvoiceId], references: [id], onDelete: Cascade)
  
  lineNumber          Int
  
  itemId              String
  item                Item            @relation(fields: [itemId], references: [id], onDelete: Restrict)
  
  warehouseId         String
  warehouse           Warehouse       @relation(fields: [warehouseId], references: [id], onDelete: Restrict)
  
  description         String?
  quantity            Decimal         @db.Decimal(10, 2)
  unitPrice           Decimal         @db.Decimal(15, 2)
  taxRate             Decimal         @default(15) @db.Decimal(5, 2)
  discountRate        Decimal         @default(0) @db.Decimal(5, 2)
  
  // Computed Fields
  lineTotal           Decimal         @db.Decimal(15, 2)
  taxAmount           Decimal         @db.Decimal(15, 2)
  discountAmount      Decimal         @db.Decimal(15, 2)
  netAmount           Decimal         @db.Decimal(15, 2)
  
  // Audit Trail
  createdAt           DateTime        @default(now())
  updatedAt           DateTime        @updatedAt
  
  @@map("purchase_invoice_lines")
  @@unique([purchaseInvoiceId, lineNumber])
  @@index([purchaseInvoiceId])
  @@index([itemId])
  @@index([warehouseId])
}

enum PurchaseReturnStatus {
  DRAFT
  POSTED
  CANCELLED
}

/// مرتجعات الشراء
model PurchaseReturn {
  id                  String               @id @default(cuid())
  returnNumber        String               @unique
  returnDate          DateTime
  status              PurchaseReturnStatus
  
  supplierId          String
  supplier            Supplier             @relation(fields: [supplierId], references: [id], onDelete: Restrict)
  
  purchaseInvoiceId   String
  purchaseInvoice     PurchaseInvoice      @relation(fields: [purchaseInvoiceId], references: [id], onDelete: Restrict)
  
  totalAmount         Decimal              @default(0) @db.Decimal(15, 2)
  
  reason              String?
  notes               String?
  
  // Multi-Entity Support
  holdingId           String?
  unitId              String?
  
  // Accounting Integration
  journalEntryId      String?
  journalEntry        JournalEntry?        @relation(fields: [journalEntryId], references: [id], onDelete: SetNull)
  
  // Relations
  lines               PurchaseReturnLine[]
  
  // Audit Trail
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt
  createdBy           String?
  updatedBy           String?
  
  @@map("purchase_returns")
  @@index([returnNumber])
  @@index([returnDate])
  @@index([status])
  @@index([supplierId])
  @@index([purchaseInvoiceId])
  @@index([journalEntryId])
  @@index([holdingId])
  @@index([unitId])
}

/// سطور مرتجعات الشراء
model PurchaseReturnLine {
  id                String         @id @default(cuid())
  
  purchaseReturnId  String
  purchaseReturn    PurchaseReturn @relation(fields: [purchaseReturnId], references: [id], onDelete: Cascade)
  
  lineNumber        Int
  
  itemId            String
  
  warehouseId       String
  
  description       String?
  quantity          Decimal        @db.Decimal(10, 2)
  unitPrice         Decimal        @db.Decimal(15, 2)
  taxRate           Decimal        @default(15) @db.Decimal(5, 2)
  
  // Computed Fields
  lineTotal         Decimal        @db.Decimal(15, 2)
  taxAmount         Decimal        @db.Decimal(15, 2)
  netAmount         Decimal        @db.Decimal(15, 2)
  
  // Audit Trail
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
  
  @@map("purchase_return_lines")
  @@unique([purchaseReturnId, lineNumber])
  @@index([purchaseReturnId])
  @@index([itemId])
  @@index([warehouseId])
}

// ============================================================================
// 10. SALES SYSTEM (نظام المبيعات)
// ============================================================================

enum SalesOrderStatus {
  DRAFT
  PENDING
  APPROVED
  PARTIALLY_INVOICED
  INVOICED
  CANCELLED
}

/// طلبات المبيعات / عروض الأسعار
model SalesOrder {
  id                    String           @id @default(cuid())
  orderNumber           String           @unique
  orderDate             DateTime
  expectedDeliveryDate  DateTime?
  status                SalesOrderStatus
  
  customerId            String
  customer              Customer         @relation(fields: [customerId], references: [id], onDelete: Restrict)
  
  subtotal              Decimal          @default(0) @db.Decimal(15, 2)
  taxAmount             Decimal          @default(0) @db.Decimal(15, 2)
  discountAmount        Decimal          @default(0) @db.Decimal(15, 2)
  totalAmount           Decimal          @default(0) @db.Decimal(15, 2)
  
  notes                 String?
  
  // Multi-Entity Support
  holdingId             String?
  unitId                String?
  projectId             String?
  
  // Relations
  lines                 SalesOrderLine[]
  invoices              SalesInvoice[]
  
  // Audit Trail
  createdAt             DateTime         @default(now())
  updatedAt             DateTime         @updatedAt
  createdBy             String?
  updatedBy             String?
  approvedAt            DateTime?
  approvedBy            String?
  
  @@map("sales_orders")
  @@index([orderNumber])
  @@index([orderDate])
  @@index([status])
  @@index([customerId])
  @@index([holdingId])
  @@index([unitId])
  @@index([projectId])
}

/// سطور طلبات المبيعات
model SalesOrderLine {
  id              String      @id @default(cuid())
  
  salesOrderId    String
  salesOrder      SalesOrder  @relation(fields: [salesOrderId], references: [id], onDelete: Cascade)
  
  lineNumber      Int
  
  itemId          String
  item            Item        @relation(fields: [itemId], references: [id], onDelete: Restrict)
  
  description     String?
  quantity        Decimal     @db.Decimal(10, 2)
  unitPrice       Decimal     @db.Decimal(15, 2)
  taxRate         Decimal     @default(15) @db.Decimal(5, 2)
  discountRate    Decimal     @default(0) @db.Decimal(5, 2)
  
  // Computed Fields
  lineTotal       Decimal     @db.Decimal(15, 2)
  taxAmount       Decimal     @db.Decimal(15, 2)
  discountAmount  Decimal     @db.Decimal(15, 2)
  netAmount       Decimal     @db.Decimal(15, 2)
  
  invoicedQuantity Decimal    @default(0) @db.Decimal(10, 2)
  
  // Audit Trail
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  
  @@map("sales_order_lines")
  @@unique([salesOrderId, lineNumber])
  @@index([salesOrderId])
  @@index([itemId])
}

enum SalesInvoiceStatus {
  DRAFT
  POSTED
  PARTIALLY_PAID
  PAID
  CANCELLED
}

/// فواتير المبيعات
model SalesInvoice {
  id                  String             @id @default(cuid())
  invoiceNumber       String             @unique
  invoiceDate         DateTime
  dueDate             DateTime?
  status              SalesInvoiceStatus
  
  customerId          String
  customer            Customer           @relation(fields: [customerId], references: [id], onDelete: Restrict)
  
  salesOrderId        String?
  salesOrder          SalesOrder?        @relation(fields: [salesOrderId], references: [id], onDelete: SetNull)
  
  subtotal            Decimal            @default(0) @db.Decimal(15, 2)
  taxAmount           Decimal            @default(0) @db.Decimal(15, 2)
  discountAmount      Decimal            @default(0) @db.Decimal(15, 2)
  totalAmount         Decimal            @default(0) @db.Decimal(15, 2)
  paidAmount          Decimal            @default(0) @db.Decimal(15, 2)
  remainingAmount     Decimal            @default(0) @db.Decimal(15, 2)
  
  notes               String?
  
  // Multi-Entity Support
  holdingId           String?
  unitId              String?
  projectId           String?
  
  // Accounting Integration
  journalEntryId      String?
  journalEntry        JournalEntry?      @relation(fields: [journalEntryId], references: [id], onDelete: SetNull)
  
  // Relations
  lines               SalesInvoiceLine[]
  returns             SalesReturn[]
  
  // Audit Trail
  createdAt           DateTime           @default(now())
  updatedAt           DateTime           @updatedAt
  createdBy           String?
  updatedBy           String?
  postedAt            DateTime?
  postedBy            String?
  
  @@map("sales_invoices")
  @@index([invoiceNumber])
  @@index([invoiceDate])
  @@index([status])
  @@index([customerId])
  @@index([salesOrderId])
  @@index([journalEntryId])
  @@index([holdingId])
  @@index([unitId])
  @@index([projectId])
}

/// سطور فواتير المبيعات
model SalesInvoiceLine {
  id                String        @id @default(cuid())
  
  salesInvoiceId    String
  salesInvoice      SalesInvoice  @relation(fields: [salesInvoiceId], references: [id], onDelete: Cascade)
  
  lineNumber        Int
  
  itemId            String
  item              Item          @relation(fields: [itemId], references: [id], onDelete: Restrict)
  
  warehouseId       String
  warehouse         Warehouse     @relation(fields: [warehouseId], references: [id], onDelete: Restrict)
  
  description       String?
  quantity          Decimal       @db.Decimal(10, 2)
  unitPrice         Decimal       @db.Decimal(15, 2)
  taxRate           Decimal       @default(15) @db.Decimal(5, 2)
  discountRate      Decimal       @default(0) @db.Decimal(5, 2)
  
  // Computed Fields
  lineTotal         Decimal       @db.Decimal(15, 2)
  taxAmount         Decimal       @db.Decimal(15, 2)
  discountAmount    Decimal       @db.Decimal(15, 2)
  netAmount         Decimal       @db.Decimal(15, 2)
  
  // Audit Trail
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  
  @@map("sales_invoice_lines")
  @@unique([salesInvoiceId, lineNumber])
  @@index([salesInvoiceId])
  @@index([itemId])
  @@index([warehouseId])
}

enum SalesReturnStatus {
  DRAFT
  POSTED
  CANCELLED
}

/// مرتجعات المبيعات
model SalesReturn {
  id                String            @id @default(cuid())
  returnNumber      String            @unique
  returnDate        DateTime
  status            SalesReturnStatus
  
  customerId        String
  customer          Customer          @relation(fields: [customerId], references: [id], onDelete: Restrict)
  
  salesInvoiceId    String
  salesInvoice      SalesInvoice      @relation(fields: [salesInvoiceId], references: [id], onDelete: Restrict)
  
  totalAmount       Decimal           @default(0) @db.Decimal(15, 2)
  
  reason            String?
  notes             String?
  
  // Multi-Entity Support
  holdingId         String?
  unitId            String?
  
  // Accounting Integration
  journalEntryId    String?
  journalEntry      JournalEntry?     @relation(fields: [journalEntryId], references: [id], onDelete: SetNull)
  
  // Relations
  lines             SalesReturnLine[]
  
  // Audit Trail
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  createdBy         String?
  updatedBy         String?
  
  @@map("sales_returns")
  @@index([returnNumber])
  @@index([returnDate])
  @@index([status])
  @@index([customerId])
  @@index([salesInvoiceId])
  @@index([journalEntryId])
  @@index([holdingId])
  @@index([unitId])
}

/// سطور مرتجعات المبيعات
model SalesReturnLine {
  id              String      @id @default(cuid())
  
  salesReturnId   String
  salesReturn     SalesReturn @relation(fields: [salesReturnId], references: [id], onDelete: Cascade)
  
  lineNumber      Int
  
  itemId          String
  
  warehouseId     String
  
  description     String?
  quantity        Decimal     @db.Decimal(10, 2)
  unitPrice       Decimal     @db.Decimal(15, 2)
  taxRate         Decimal     @default(15) @db.Decimal(5, 2)
  
  // Computed Fields
  lineTotal       Decimal     @db.Decimal(15, 2)
  taxAmount       Decimal     @db.Decimal(15, 2)
  netAmount       Decimal     @db.Decimal(15, 2)
  
  // Audit Trail
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  
  @@map("sales_return_lines")
  @@unique([salesReturnId, lineNumber])
  @@index([salesReturnId])
  @@index([itemId])
  @@index([warehouseId])
}

// ============================================================================
// 6. HR & PAYROLL SYSTEM (نظام الموارد البشرية والرواتب)
// ============================================================================

// ============================================================================
// 6.1 HR ENUMS
// ============================================================================

/// الجنس
enum Gender {
  MALE
  FEMALE
}

/// الحالة الاجتماعية
enum MaritalStatus {
  SINGLE
  MARRIED
  DIVORCED
  WIDOWED
}

/// حالة التوظيف
enum EmploymentStatus {
  ACTIVE
  ON_LEAVE
  SUSPENDED
  TERMINATED
  RESIGNED
  RETIRED
}

/// نوع التوظيف
enum EmploymentType {
  FULL_TIME
  PART_TIME
  CONTRACT
  TEMPORARY
  INTERN
}

/// المستوى الوظيفي
enum PositionLevel {
  ENTRY
  JUNIOR
  INTERMEDIATE
  SENIOR
  LEAD
  MANAGER
  DIRECTOR
  EXECUTIVE
}

/// فئة الوظيفة
enum PositionCategory {
  TECHNICAL
  ADMINISTRATIVE
  SALES
  OPERATIONS
  FINANCE
  HR
  LEGAL
  OTHER
}

/// نوع المستند
enum DocumentType {
  PASSPORT
  NATIONAL_ID
  DRIVING_LICENSE
  WORK_PERMIT
  VISA
  CERTIFICATE
  CONTRACT
  OTHER
}

/// نوع العقد
enum ContractType {
  PERMANENT
  FIXED_TERM
  PROBATION
  TEMPORARY
}

/// حالة العقد
enum ContractStatus {
  DRAFT
  ACTIVE
  EXPIRED
  TERMINATED
}

/// حالة الحضور
enum AttendanceStatus {
  PRESENT
  ABSENT
  LATE
  EARLY_LEAVE
  ON_LEAVE
  HOLIDAY
  WEEKEND
}

/// طريقة التسجيل
enum CheckMethod {
  BIOMETRIC
  MOBILE_APP
  WEB
  MANUAL
}

/// حالة الطلب
enum RequestStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED
}

/// حالة فترة الرواتب
enum PayrollPeriodStatus {
  DRAFT
  PROCESSING
  PROCESSED
  APPROVED
  PAID
  CLOSED
}

/// حالة سطر الراتب
enum PayrollItemStatus {
  PENDING
  PROCESSED
  PAID
}

/// طريقة الدفع
enum PaymentMethod {
  BANK_TRANSFER
  CASH
  CHEQUE
}

/// نوع الحساب
enum CalculationType {
  FIXED_AMOUNT
  PERCENTAGE
  FORMULA
}


// ============================================================================
// 6.2 EMPLOYEE MANAGEMENT MODELS
// ============================================================================

/// الأقسام
model Department {
  id          String   @id @default(cuid())
  code        String   @unique
  nameEn      String
  nameAr      String
  parentId    String?
  managerId   String?
  costCenterId String?
  holdingId   String?
  unitId      String?
  projectId   String?
  description String?
  isActive    Boolean  @default(true)
  
  // Relations
  parent      Department?  @relation("DepartmentHierarchy", fields: [parentId], references: [id], onDelete: Restrict)
  children    Department[] @relation("DepartmentHierarchy")
  manager     Employee?    @relation("DepartmentManager", fields: [managerId], references: [id], onDelete: SetNull)
  costCenter  CostCenter?  @relation(fields: [costCenterId], references: [id], onDelete: SetNull)
  holding     Holding?     @relation(fields: [holdingId], references: [id], onDelete: Cascade)
  unit        Unit?        @relation(fields: [unitId], references: [id], onDelete: Cascade)
  project     Project?     @relation(fields: [projectId], references: [id], onDelete: Cascade)
  employees   Employee[]   @relation("EmployeeDepartment")
  
  // Audit
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdBy   String?
  updatedBy   String?
  
  @@map("departments")
  @@index([code])
  @@index([parentId])
  @@index([managerId])
  @@index([holdingId])
  @@index([unitId])
  @@index([isActive])
}

/// الوظائف
model Position {
  id          String           @id @default(cuid())
  code        String           @unique
  titleEn     String
  titleAr     String
  level       PositionLevel
  category    PositionCategory
  minSalary   Decimal?         @db.Decimal(15, 2)
  maxSalary   Decimal?         @db.Decimal(15, 2)
  description String?          @db.Text
  requirements String?         @db.Text
  isActive    Boolean          @default(true)
  
  // Relations
  employees   Employee[]
  
  // Audit
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdBy   String?
  updatedBy   String?
  
  @@map("positions")
  @@index([code])
  @@index([level])
  @@index([category])
  @@index([isActive])
}

/// مواقع العمل
model WorkLocation {
  id          String   @id @default(cuid())
  code        String   @unique
  nameEn      String
  nameAr      String
  address     String?  @db.Text
  city        String?
  country     String?
  latitude    Decimal? @db.Decimal(10, 8)
  longitude   Decimal? @db.Decimal(11, 8)
  radius      Int?
  holdingId   String?
  unitId      String?
  isActive    Boolean  @default(true)
  
  // Relations
  holding     Holding?   @relation(fields: [holdingId], references: [id], onDelete: Cascade)
  unit        Unit?      @relation(fields: [unitId], references: [id], onDelete: Cascade)
  employees   Employee[]
  
  // Audit
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdBy   String?
  updatedBy   String?
  
  @@map("work_locations")
  @@index([code])
  @@index([holdingId])
  @@index([unitId])
  @@index([isActive])
}

/// الموظفون
model Employee {
  id                      String           @id @default(cuid())
  code                    String           @unique
  firstName               String
  middleName              String?
  lastName                String
  firstNameAr             String
  middleNameAr            String?
  lastNameAr              String
  nationalId              String?          @unique
  passportNumber          String?          @unique
  dateOfBirth             DateTime         @db.Date
  gender                  Gender
  maritalStatus           MaritalStatus
  nationality             String?
  email                   String?          @unique
  phone                   String?
  mobile                  String?
  address                 String?          @db.Text
  city                    String?
  country                 String?
  postalCode              String?
  hireDate                DateTime         @db.Date
  terminationDate         DateTime?        @db.Date
  employmentStatus        EmploymentStatus
  employmentType          EmploymentType
  probationEndDate        DateTime?        @db.Date
  departmentId            String?
  positionId              String?
  managerId               String?
  workLocationId          String?
  bankName                String?
  bankAccountNumber       String?
  bankIBAN                String?
  emergencyContactName    String?
  emergencyContactPhone   String?
  emergencyContactRelation String?
  holdingId               String?
  unitId                  String?
  projectId               String?
  notes                   String?          @db.Text
  isActive                Boolean          @default(true)
  
  // Relations
  department              Department?      @relation("EmployeeDepartment", fields: [departmentId], references: [id], onDelete: SetNull)
  position                Position?        @relation(fields: [positionId], references: [id], onDelete: SetNull)
  manager                 Employee?        @relation("EmployeeManager", fields: [managerId], references: [id], onDelete: SetNull)
  subordinates            Employee[]       @relation("EmployeeManager")
  workLocation            WorkLocation?    @relation(fields: [workLocationId], references: [id], onDelete: SetNull)
  holding                 Holding?         @relation(fields: [holdingId], references: [id], onDelete: Cascade)
  unit                    Unit?            @relation(fields: [unitId], references: [id], onDelete: Cascade)
  project                 Project?         @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  // Reverse relations
  managedDepartments      Department[]     @relation("DepartmentManager")
  documents               EmployeeDocument[]
  contracts               EmployeeContract[]
  attendanceRecords       AttendanceRecord[]
  shifts                  EmployeeShift[]
  overtimeRequests        OvertimeRequest[]
  leaveBalances           LeaveBalance[]
  leaveRequests           LeaveRequest[]
  payrollItems            PayrollItem[]
  employeeAllowances      EmployeeAllowance[]
  employeeDeductions      EmployeeDeduction[]
  loanRequests            LoanRequest[]
  
  // Audit
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt
  createdBy               String?
  updatedBy               String?
  
  @@map("employees")
  @@index([code])
  @@index([nationalId])
  @@index([email])
  @@index([departmentId])
  @@index([positionId])
  @@index([managerId])
  @@index([employmentStatus])
  @@index([holdingId])
  @@index([unitId])
  @@index([hireDate])
  @@index([isActive])
}

/// مستندات الموظفين
model EmployeeDocument {
  id             String       @id @default(cuid())
  employeeId     String
  documentType   DocumentType
  documentNumber String?
  title          String
  issueDate      DateTime?    @db.Date
  expiryDate     DateTime?    @db.Date
  filePath       String?
  fileSize       Int?
  mimeType       String?
  notes          String?      @db.Text
  
  // Relations
  employee       Employee     @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  
  // Audit
  createdAt      DateTime @default(now())
  createdBy      String?
  
  @@map("employee_documents")
  @@index([employeeId])
  @@index([documentType])
  @@index([expiryDate])
}

/// عقود الموظفين
model EmployeeContract {
  id                  String         @id @default(cuid())
  employeeId          String
  contractNumber      String         @unique
  contractType        ContractType
  startDate           DateTime       @db.Date
  endDate             DateTime?      @db.Date
  basicSalary         Decimal        @db.Decimal(15, 2)
  currency            String         @default("SAR")
  workingHoursPerDay  Decimal?       @db.Decimal(4, 2)
  workingDaysPerWeek  Int?
  annualLeaveDays     Int?
  probationPeriodDays Int?
  noticePeriodDays    Int?
  filePath            String?
  status              ContractStatus
  notes               String?        @db.Text
  isActive            Boolean        @default(true)
  
  // Relations
  employee            Employee       @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  
  // Audit
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  createdBy           String?
  updatedBy           String?
  
  @@map("employee_contracts")
  @@index([employeeId])
  @@index([contractNumber])
  @@index([status])
  @@index([startDate])
  @@index([endDate])
  @@index([isActive])
}


// ============================================================================
// 6.3 ATTENDANCE MANAGEMENT MODELS
// ============================================================================

/// الورديات
model Shift {
  id            String   @id @default(cuid())
  code          String   @unique
  nameEn        String
  nameAr        String
  startTime     DateTime @db.Time
  endTime       DateTime @db.Time
  workingHours  Decimal  @db.Decimal(4, 2)
  breakMinutes  Int      @default(0)
  graceMinutes  Int      @default(0)
  isOvernight   Boolean  @default(false)
  color         String?
  isActive      Boolean  @default(true)
  
  // Relations
  employeeShifts      EmployeeShift[]
  attendanceRecords   AttendanceRecord[]
  
  // Audit
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdBy   String?
  updatedBy   String?
  
  @@map("shifts")
  @@index([code])
  @@index([isActive])
}

/// ربط الموظفين بالورديات
model EmployeeShift {
  id            String   @id @default(cuid())
  employeeId    String
  shiftId       String
  effectiveDate DateTime @db.Date
  endDate       DateTime? @db.Date
  isActive      Boolean  @default(true)
  
  // Relations
  employee      Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  shift         Shift    @relation(fields: [shiftId], references: [id], onDelete: Cascade)
  
  // Audit
  createdAt     DateTime @default(now())
  createdBy     String?
  
  @@map("employee_shifts")
  @@index([employeeId])
  @@index([shiftId])
  @@index([effectiveDate])
  @@index([isActive])
}

/// سجلات الحضور
model AttendanceRecord {
  id                  String           @id @default(cuid())
  employeeId          String
  date                DateTime         @db.Date
  checkInTime         DateTime?
  checkOutTime        DateTime?
  checkInLocation     String?
  checkOutLocation    String?
  checkInLatitude     Decimal?         @db.Decimal(10, 8)
  checkInLongitude    Decimal?         @db.Decimal(11, 8)
  checkOutLatitude    Decimal?         @db.Decimal(10, 8)
  checkOutLongitude   Decimal?         @db.Decimal(11, 8)
  checkInMethod       CheckMethod?
  checkOutMethod      CheckMethod?
  workingHours        Decimal?         @db.Decimal(5, 2)
  overtimeHours       Decimal?         @db.Decimal(5, 2)
  lateMinutes         Int?
  earlyLeaveMinutes   Int?
  status              AttendanceStatus
  shiftId             String?
  notes               String?          @db.Text
  approvedBy          String?
  approvedAt          DateTime?
  
  // Relations
  employee            Employee         @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  shift               Shift?           @relation(fields: [shiftId], references: [id], onDelete: SetNull)
  
  // Audit
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  
  @@map("attendance_records")
  @@unique([employeeId, date])
  @@index([employeeId, date])
  @@index([date])
  @@index([status])
  @@index([shiftId])
}

/// طلبات العمل الإضافي
model OvertimeRequest {
  id              String        @id @default(cuid())
  requestNumber   String        @unique
  employeeId      String
  date            DateTime      @db.Date
  startTime       DateTime      @db.Time
  endTime         DateTime      @db.Time
  hours           Decimal       @db.Decimal(5, 2)
  reason          String        @db.Text
  status          RequestStatus
  requestedAt     DateTime
  approvedBy      String?
  approvedAt      DateTime?
  rejectionReason String?       @db.Text
  
  // Relations
  employee        Employee      @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  
  // Audit
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@map("overtime_requests")
  @@index([employeeId])
  @@index([status])
  @@index([date])
  @@index([requestNumber])
}


// ============================================================================
// 6.4 LEAVE MANAGEMENT MODELS
// ============================================================================

/// أنواع الإجازات
model LeaveType {
  id                String   @id @default(cuid())
  code              String   @unique
  nameEn            String
  nameAr            String
  isPaid            Boolean  @default(true)
  maxDaysPerYear    Int?
  requiresApproval  Boolean  @default(true)
  canCarryForward   Boolean  @default(false)
  color             String?
  description       String?  @db.Text
  isActive          Boolean  @default(true)
  
  // Relations
  leaveBalances     LeaveBalance[]
  leaveRequests     LeaveRequest[]
  
  // Audit
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  createdBy         String?
  updatedBy         String?
  
  @@map("leave_types")
  @@index([code])
  @@index([isActive])
}

/// أرصدة الإجازات
model LeaveBalance {
  id              String    @id @default(cuid())
  employeeId      String
  leaveTypeId     String
  year            Int
  entitlement     Decimal   @db.Decimal(5, 2)
  used            Decimal   @default(0) @db.Decimal(5, 2)
  balance         Decimal   @db.Decimal(5, 2)
  carriedForward  Decimal   @default(0) @db.Decimal(5, 2)
  
  // Relations
  employee        Employee  @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  leaveType       LeaveType @relation(fields: [leaveTypeId], references: [id], onDelete: Cascade)
  
  // Audit
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@map("leave_balances")
  @@unique([employeeId, leaveTypeId, year])
  @@index([employeeId])
  @@index([leaveTypeId])
  @@index([year])
}

/// طلبات الإجازات
model LeaveRequest {
  id              String        @id @default(cuid())
  requestNumber   String        @unique
  employeeId      String
  leaveTypeId     String
  startDate       DateTime      @db.Date
  endDate         DateTime      @db.Date
  days            Decimal       @db.Decimal(5, 2)
  reason          String?       @db.Text
  status          RequestStatus
  requestedAt     DateTime
  approvedBy      String?
  approvedAt      DateTime?
  rejectionReason String?       @db.Text
  
  // Relations
  employee        Employee      @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  leaveType       LeaveType     @relation(fields: [leaveTypeId], references: [id], onDelete: Cascade)
  
  // Audit
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@map("leave_requests")
  @@index([employeeId])
  @@index([leaveTypeId])
  @@index([status])
  @@index([startDate, endDate])
  @@index([requestNumber])
}


// ============================================================================
// 6.5 PAYROLL MANAGEMENT MODELS
// ============================================================================

/// فترات الرواتب
model PayrollPeriod {
  id                String              @id @default(cuid())
  periodNumber      String              @unique
  year              Int
  month             Int
  startDate         DateTime            @db.Date
  endDate           DateTime            @db.Date
  paymentDate       DateTime?           @db.Date
  status            PayrollPeriodStatus
  totalEmployees    Int                 @default(0)
  totalGrossPay     Decimal             @default(0) @db.Decimal(15, 2)
  totalDeductions   Decimal             @default(0) @db.Decimal(15, 2)
  totalNetPay       Decimal             @default(0) @db.Decimal(15, 2)
  processedAt       DateTime?
  processedBy       String?
  approvedAt        DateTime?
  approvedBy        String?
  journalEntryId    String?
  holdingId         String?
  unitId            String?
  notes             String?             @db.Text
  
  // Relations
  journalEntry      JournalEntry?       @relation(fields: [journalEntryId], references: [id], onDelete: SetNull)
  holding           Holding?            @relation(fields: [holdingId], references: [id], onDelete: Cascade)
  unit              Unit?               @relation(fields: [unitId], references: [id], onDelete: Cascade)
  payrollItems      PayrollItem[]
  
  // Audit
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  @@map("payroll_periods")
  @@unique([year, month, holdingId, unitId])
  @@index([periodNumber])
  @@index([year, month])
  @@index([status])
  @@index([holdingId])
  @@index([unitId])
}

/// سطور الرواتب
model PayrollItem {
  id               String            @id @default(cuid())
  payrollPeriodId  String
  employeeId       String
  basicSalary      Decimal           @db.Decimal(15, 2)
  allowances       Decimal           @default(0) @db.Decimal(15, 2)
  overtimePay      Decimal           @default(0) @db.Decimal(15, 2)
  bonuses          Decimal           @default(0) @db.Decimal(15, 2)
  grossPay         Decimal           @db.Decimal(15, 2)
  deductions       Decimal           @default(0) @db.Decimal(15, 2)
  netPay           Decimal           @db.Decimal(15, 2)
  workingDays      Int?
  absentDays       Int               @default(0)
  overtimeHours    Decimal           @default(0) @db.Decimal(5, 2)
  status           PayrollItemStatus
  paidAt           DateTime?
  paymentMethod    PaymentMethod?
  paymentReference String?
  notes            String?           @db.Text
  
  // Relations
  payrollPeriod    PayrollPeriod     @relation(fields: [payrollPeriodId], references: [id], onDelete: Cascade)
  employee         Employee          @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  payrollAllowances PayrollAllowance[]
  payrollDeductions PayrollDeduction[]
  payrollBonuses    PayrollBonus[]
  
  // Audit
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  
  @@map("payroll_items")
  @@unique([payrollPeriodId, employeeId])
  @@index([payrollPeriodId])
  @@index([employeeId])
  @@index([status])
}

/// بدلات الرواتب
model PayrollAllowance {
  id              String   @id @default(cuid())
  payrollItemId   String
  allowanceTypeId String
  amount          Decimal  @db.Decimal(15, 2)
  notes           String?  @db.Text
  
  // Relations
  payrollItem     PayrollItem    @relation(fields: [payrollItemId], references: [id], onDelete: Cascade)
  allowanceType   AllowanceType  @relation(fields: [allowanceTypeId], references: [id], onDelete: Cascade)
  
  // Audit
  createdAt       DateTime @default(now())
  
  @@map("payroll_allowances")
  @@index([payrollItemId])
  @@index([allowanceTypeId])
}

/// خصومات الرواتب
model PayrollDeduction {
  id              String   @id @default(cuid())
  payrollItemId   String
  deductionTypeId String
  amount          Decimal  @db.Decimal(15, 2)
  notes           String?  @db.Text
  
  // Relations
  payrollItem     PayrollItem    @relation(fields: [payrollItemId], references: [id], onDelete: Cascade)
  deductionType   DeductionType  @relation(fields: [deductionTypeId], references: [id], onDelete: Cascade)
  
  // Audit
  createdAt       DateTime @default(now())
  
  @@map("payroll_deductions")
  @@index([payrollItemId])
  @@index([deductionTypeId])
}

/// مكافآت الرواتب
model PayrollBonus {
  id            String   @id @default(cuid())
  payrollItemId String
  bonusTypeId   String
  amount        Decimal  @db.Decimal(15, 2)
  notes         String?  @db.Text
  
  // Relations
  payrollItem   PayrollItem @relation(fields: [payrollItemId], references: [id], onDelete: Cascade)
  bonusType     BonusType   @relation(fields: [bonusTypeId], references: [id], onDelete: Cascade)
  
  // Audit
  createdAt     DateTime @default(now())
  
  @@map("payroll_bonuses")
  @@index([payrollItemId])
  @@index([bonusTypeId])
}


// ============================================================================
// 6.6 DEDUCTIONS & BENEFITS MODELS
// ============================================================================

/// أنواع البدلات
model AllowanceType {
  id                String          @id @default(cuid())
  code              String          @unique
  nameEn            String
  nameAr            String
  calculationType   CalculationType
  defaultAmount     Decimal?        @db.Decimal(15, 2)
  defaultPercentage Decimal?        @db.Decimal(5, 2)
  isTaxable         Boolean         @default(true)
  accountId         String?
  description       String?         @db.Text
  isActive          Boolean         @default(true)
  
  // Relations
  account           Account?        @relation(fields: [accountId], references: [id], onDelete: SetNull)
  employeeAllowances EmployeeAllowance[]
  payrollAllowances  PayrollAllowance[]
  
  // Audit
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  createdBy         String?
  updatedBy         String?
  
  @@map("allowance_types")
  @@index([code])
  @@index([isActive])
}

/// أنواع الخصومات
model DeductionType {
  id                String          @id @default(cuid())
  code              String          @unique
  nameEn            String
  nameAr            String
  calculationType   CalculationType
  defaultAmount     Decimal?        @db.Decimal(15, 2)
  defaultPercentage Decimal?        @db.Decimal(5, 2)
  isStatutory       Boolean         @default(false)
  accountId         String?
  description       String?         @db.Text
  isActive          Boolean         @default(true)
  
  // Relations
  account           Account?        @relation(fields: [accountId], references: [id], onDelete: SetNull)
  employeeDeductions EmployeeDeduction[]
  payrollDeductions  PayrollDeduction[]
  
  // Audit
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  createdBy         String?
  updatedBy         String?
  
  @@map("deduction_types")
  @@index([code])
  @@index([isActive])
}

/// أنواع المكافآت
model BonusType {
  id                String          @id @default(cuid())
  code              String          @unique
  nameEn            String
  nameAr            String
  calculationType   CalculationType
  defaultAmount     Decimal?        @db.Decimal(15, 2)
  defaultPercentage Decimal?        @db.Decimal(5, 2)
  isTaxable         Boolean         @default(true)
  accountId         String?
  description       String?         @db.Text
  isActive          Boolean         @default(true)
  
  // Relations
  account           Account?        @relation(fields: [accountId], references: [id], onDelete: SetNull)
  payrollBonuses    PayrollBonus[]
  
  // Audit
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  createdBy         String?
  updatedBy         String?
  
  @@map("bonus_types")
  @@index([code])
  @@index([isActive])
}

/// بدلات الموظفين الثابتة
model EmployeeAllowance {
  id              String        @id @default(cuid())
  employeeId      String
  allowanceTypeId String
  amount          Decimal?      @db.Decimal(15, 2)
  percentage      Decimal?      @db.Decimal(5, 2)
  effectiveDate   DateTime      @db.Date
  endDate         DateTime?     @db.Date
  isActive        Boolean       @default(true)
  
  // Relations
  employee        Employee      @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  allowanceType   AllowanceType @relation(fields: [allowanceTypeId], references: [id], onDelete: Cascade)
  
  // Audit
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  createdBy       String?
  updatedBy       String?
  
  @@map("employee_allowances")
  @@index([employeeId])
  @@index([allowanceTypeId])
  @@index([effectiveDate])
  @@index([isActive])
}

/// خصومات الموظفين الثابتة
model EmployeeDeduction {
  id              String        @id @default(cuid())
  employeeId      String
  deductionTypeId String
  amount          Decimal?      @db.Decimal(15, 2)
  percentage      Decimal?      @db.Decimal(5, 2)
  effectiveDate   DateTime      @db.Date
  endDate         DateTime?     @db.Date
  isActive        Boolean       @default(true)
  
  // Relations
  employee        Employee      @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  deductionType   DeductionType @relation(fields: [deductionTypeId], references: [id], onDelete: Cascade)
  
  // Audit
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  createdBy       String?
  updatedBy       String?
  
  @@map("employee_deductions")
  @@index([employeeId])
  @@index([deductionTypeId])
  @@index([effectiveDate])
  @@index([isActive])
}

/// طلبات السلف
model LoanRequest {
  id               String        @id @default(cuid())
  requestNumber    String        @unique
  employeeId       String
  amount           Decimal       @db.Decimal(15, 2)
  installments     Int
  installmentAmount Decimal      @db.Decimal(15, 2)
  startDate        DateTime      @db.Date
  reason           String        @db.Text
  status           RequestStatus
  paidInstallments Int           @default(0)
  remainingAmount  Decimal?      @db.Decimal(15, 2)
  requestedAt      DateTime
  approvedBy       String?
  approvedAt       DateTime?
  rejectionReason  String?       @db.Text
  
  // Relations
  employee         Employee      @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  
  // Audit
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  
  @@map("loan_requests")
  @@index([employeeId])
  @@index([status])
  @@index([requestNumber])
}

