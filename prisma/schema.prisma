// Prisma Schema for SEMOP ERP System
// Version: 2.1.10
// Date: 2025-11-27

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// Cycle 4 - New Models (6 tables)
// ============================================

// 1. Genes System
model Gene {
  id          Int      @id @default(autoincrement())
  name        String   @unique
  symbol      String   @unique
  description String?
  category    String   // ACCOUNTING, INVENTORY, SALES, PURCHASES
  geneType    String   @map("gene_type") // PUBLIC, PRIVATE
  sectorId    String?  @map("sector_id")
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("genes")
}

// 2. Latitude Points (Maps System)
model LatitudePoint {
  id          Int      @id @default(autoincrement())
  latitude    Float
  longitude   Float
  pointName   String   @unique @map("point_name")
  description String?
  address     String?
  city        String?
  country     String?  @default("Yemen")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("latitude_points")
}

// 3. Purchase Orders
model PurchaseOrder {
  id           String   @id @default(uuid())
  orderNumber  String   @unique @map("order_number")
  supplierId   String   @map("supplier_id")
  orderDate    DateTime @default(now()) @map("order_date")
  deliveryDate DateTime? @map("delivery_date")
  status       String   @default("Pending") // Pending, Approved, Rejected, Completed
  totalAmount  Float    @map("total_amount")
  notes        String?
  createdBy    String?  @map("created_by")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  @@map("purchase_orders")
}

// 4. Account Hierarchy
model AccountHierarchy {
  id            String   @id @default(uuid())
  accountId     String   @unique @map("account_id")
  parentId      String?  @map("parent_id")
  level         Int      @default(1)
  path          String   // e.g., "1.2.3"
  name          String
  description   String?
  isActive      Boolean  @default(true) @map("is_active")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  @@map("account_hierarchy")
}

// 5. Role Permissions
model RolePermission {
  id           String   @id @default(uuid())
  roleId       String   @map("role_id")
  permissionId String   @map("permission_id")
  canCreate    Boolean  @default(false) @map("can_create")
  canRead      Boolean  @default(true) @map("can_read")
  canUpdate    Boolean  @default(false) @map("can_update")
  canDelete    Boolean  @default(false) @map("can_delete")
  assignedBy   String?  @map("assigned_by")
  assignedAt   DateTime @default(now()) @map("assigned_at")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  @@unique([roleId, permissionId])
  @@map("role_permissions")
}

// 6. Customer Contacts
model CustomerContact {
  id          Int      @id @default(autoincrement())
  customerId  String   @map("customer_id")
  contactName String   @map("contact_name")
  email       String?
  phone       String?
  position    String?
  isPrimary   Boolean  @default(false) @map("is_primary")
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("customer_contacts")
}
// ============================================
// Cycle 5 - New Tables (Tasks 81-85)
// ============================================

// 1. Notifications System (Task 81)
model Notification {
  id          String   @id @default(uuid())
  userId      String   @map("user_id")
  title       String
  message     String   @db.Text
  type        String   // info, success, warning, error
  isRead      Boolean  @default(false) @map("is_read")
  link        String?  // Optional link to related resource
  metadata    Json?    // Additional data
  createdAt   DateTime @default(now()) @map("created_at")
  readAt      DateTime? @map("read_at")
  
  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
  @@map("notifications")
}

// 2. File Attachments System (Task 82)
model Attachment {
  id           String   @id @default(uuid())
  fileName     String   @map("file_name")
  originalName String   @map("original_name")
  filePath     String   @map("file_path")
  fileSize     Int      @map("file_size") // in bytes
  mimeType     String   @map("mime_type")
  entityType   String   @map("entity_type") // e.g., "customer", "order", "product"
  entityId     String   @map("entity_id")
  uploadedBy   String   @map("uploaded_by")
  description  String?
  isPublic     Boolean  @default(false) @map("is_public")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")
  
  @@index([entityType, entityId])
  @@index([uploadedBy])
  @@map("attachments")
}

// 3. Audit Logs System (Task 83)
model AuditLog {
  id          String   @id @default(uuid())
  userId      String   @map("user_id")
  userName    String   @map("user_name")
  action      String   // CREATE, READ, UPDATE, DELETE
  entityType  String   @map("entity_type")
  entityId    String   @map("entity_id")
  oldValue    Json?    @map("old_value")
  newValue    Json?    @map("new_value")
  ipAddress   String?  @map("ip_address")
  userAgent   String?  @map("user_agent")
  timestamp   DateTime @default(now())
  
  @@index([userId])
  @@index([entityType, entityId])
  @@index([timestamp])
  @@index([action])
  @@map("audit_logs")
}

// 4. Backup System (Task 84)
model Backup {
  id          String   @id @default(uuid())
  fileName    String   @map("file_name")
  filePath    String   @map("file_path")
  fileSize    Int      @map("file_size") // in bytes
  backupType  String   @map("backup_type") // full, incremental, differential
  status      String   @default("pending") // pending, in_progress, completed, failed
  startedAt   DateTime @default(now()) @map("started_at")
  completedAt DateTime? @map("completed_at")
  createdBy   String   @map("created_by")
  description String?
  metadata    Json?    // Additional backup info
  
  @@index([status])
  @@index([startedAt])
  @@index([backupType])
  @@map("backups")
}

// 5. System Settings (Task 85)
model SystemSetting {
  id          String   @id @default(uuid())
  key         String   @unique
  value       String   @db.Text
  category    String   // general, security, email, notifications, etc.
  dataType    String   @map("data_type") // string, number, boolean, json
  description String?
  isPublic    Boolean  @default(false) @map("is_public")
  updatedBy   String?  @map("updated_by")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  
  @@index([category])
  @@index([key])
  @@map("system_settings")
}
