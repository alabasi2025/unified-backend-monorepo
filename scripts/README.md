# دليل سكريبت النسخ الاحتياطي لقاعدة بيانات PostgreSQL

هذا الدليل يوضح كيفية استخدام وتكوين وجدولة سكريبت النسخ الاحتياطي لقاعدة بيانات PostgreSQL الخاصة بنظام SEMOP ERP.

## 1. سكريبت النسخ الاحتياطي: `backup_semop_db.sh`

### الغرض
يقوم هذا السكريبت بإنشاء نسخة احتياطية كاملة لقاعدة بيانات PostgreSQL باستخدام أداة `pg_dump` بصيغة مخصصة ومضغوطة (`-Fc`). كما يطبق سياسة احتفاظ (Retention Policy) لحذف النسخ الاحتياطية القديمة تلقائيًا.

### التكوين (Configuration)

يجب تعديل المتغيرات التالية داخل السكريبت (`backup_semop_db.sh`) لتناسب بيئة الخادم الخاص بك:

| المتغير | الوصف | القيمة الافتراضية |
| :--- | :--- | :--- |
| `DB_NAME` | اسم قاعدة البيانات المراد نسخها احتياطيًا. | `semop_erp_db` |
| `DB_USER` | اسم مستخدم PostgreSQL الذي لديه صلاحية النسخ الاحتياطي. | `semop_user` |
| `BACKUP_DIR` | المسار الكامل لحفظ ملفات النسخ الاحتياطي. | `/var/backups/postgresql/semop` |
| `RETENTION_DAYS` | عدد الأيام التي سيتم الاحتفاظ بالنسخ الاحتياطية خلالها. | `7` |

### سياسة الاحتفاظ (Retention Policy)
السكريبت مُعد لحذف أي ملفات نسخ احتياطي (بصيغة `.dump`) في مجلد `BACKUP_DIR` يزيد عمرها عن `RETENTION_DAYS` (افتراضيًا 7 أيام).

## 2. خطوات الإعداد على الخادم (VPS)

لضمان عمل السكريبت بشكل آلي وموثوق على الخادم (VPS - 72.61.111.217)، اتبع الخطوات التالية:

### أ. نقل السكريبت
انقل ملف `backup_semop_db.sh` إلى مسار آمن على الخادم، مثل `/usr/local/bin/` أو `/opt/scripts/`.

### ب. إعداد الصلاحيات
اجعل السكريبت قابلاً للتنفيذ:
```bash
chmod +x /path/to/backup_semop_db.sh
```

### ج. إعداد بيئة PostgreSQL
يجب أن يكون المستخدم الذي سيقوم بتشغيل السكريبت (عادةً مستخدم النظام الذي سيتم جدولة المهمة تحته) قادرًا على الاتصال بقاعدة البيانات دون الحاجة لإدخال كلمة مرور تفاعليًا. هناك طريقتان رئيسيتان:

1.  **استخدام ملف `.pgpass`:**
    أنشئ ملف `.pgpass` في الدليل الرئيسي للمستخدم الذي سيقوم بالجدولة (`~/.pgpass`) وقم بتعيين الصلاحيات المناسبة له (`chmod 0600 ~/.pgpass`).
    محتوى الملف يجب أن يكون بالصيغة التالية:
    ```
    hostname:port:database:username:password
    ```
    مثال:
    ```
    localhost:5432:semop_erp_db:semop_user:YourStrongPassword
    ```

2.  **استخدام متغيرات البيئة:**
    يمكن تعيين متغيرات البيئة `PGHOST`, `PGPORT`, `PGUSER`, و `PGPASSWORD` في ملف `crontab` أو في ملف إعداد بيئة المستخدم.

### د. جدولة النسخ الاحتياطي باستخدام Cron
لجدولة السكريبت ليتم تشغيله يوميًا في وقت محدد (مثلاً، الساعة 02:00 صباحًا)، قم بتحرير ملف `crontab` الخاص بالمستخدم:

```bash
crontab -e
```

أضف السطر التالي (مع استبدال المسار الفعلي للسكريبت):

```cron
# M H D M W command
0 2 * * * /path/to/backup_semop_db.sh > /var/log/semop_backup.log 2>&1
```

هذا الأمر سيقوم بتشغيل السكريبت يوميًا في الساعة الثانية صباحًا، وسيقوم بتسجيل المخرجات والأخطاء في ملف `/var/log/semop_backup.log`.

### هـ. إنشاء مجلد النسخ الاحتياطي
تأكد من إنشاء مجلد النسخ الاحتياطي على الخادم ومنح الصلاحيات المناسبة له:
```bash
mkdir -p /var/backups/postgresql/semop
chown postgres:postgres /var/backups/postgresql/semop # أو المستخدم الذي سيقوم بالنسخ
chmod 700 /var/backups/postgresql/semop
```

## 3. استعادة قاعدة البيانات (Restoration)

لإجراء عملية استعادة من ملف النسخ الاحتياطي (بصيغة `.dump` المخصصة)، استخدم الأمر `pg_restore`:

```bash
pg_restore -U semop_user -d semop_erp_db -Fc /var/backups/postgresql/semop/semop_erp_db_backup_YYYYMMDD_HHMMSS.dump
```

**ملاحظة:** يجب أن تكون قاعدة البيانات `semop_erp_db` موجودة (وقد تكون فارغة) قبل تشغيل أمر الاستعادة. إذا كنت تستعيد إلى قاعدة بيانات جديدة، قد تحتاج إلى إنشائها أولاً.
